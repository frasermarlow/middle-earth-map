<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Middle-earth — Interactive Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, Georgia, serif;
            background: #1a1a1a;
            overflow: hidden;
        }

        #map {
            width: 100vw;
            height: 100vh;
            background: #2c2418;
        }

        /* Legend Panel */
        #legend {
            position: absolute;
            top: 16px;
            right: 16px;
            z-index: 1000;
            background: rgba(44, 36, 24, 0.95);
            border: 2px solid #8b7355;
            border-radius: 8px;
            padding: 16px;
            color: #d4c5a9;
            max-width: 280px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            max-height: calc(100vh - 32px);
            overflow-y: auto;
        }

        #legend h2 {
            font-size: 16px;
            color: #e8d9b0;
            margin-bottom: 12px;
            text-align: center;
            border-bottom: 1px solid #8b7355;
            padding-bottom: 8px;
            letter-spacing: 1px;
        }

        .legend-category {
            margin-bottom: 10px;
        }

        .legend-category-header {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 6px 0;
            user-select: none;
        }

        .legend-category-header:hover {
            color: #f0e6cc;
        }

        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
            flex-shrink: 0;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .legend-category-label {
            font-size: 13px;
            font-weight: bold;
            flex-grow: 1;
        }

        .legend-toggle {
            font-size: 11px;
            opacity: 0.7;
            margin-left: 8px;
        }

        .legend-items {
            margin-left: 20px;
            font-size: 12px;
            color: #b8a88a;
        }

        .legend-item {
            padding: 3px 0;
            cursor: pointer;
            transition: color 0.2s;
        }

        .legend-item:hover {
            color: #f0e6cc;
        }

        .legend-category.disabled .legend-dot {
            opacity: 0.3;
        }

        .legend-category.disabled .legend-category-label {
            opacity: 0.4;
            text-decoration: line-through;
        }

        .legend-category.disabled .legend-items {
            display: none;
        }

        #collapse-btn {
            position: absolute;
            top: 16px;
            right: 16px;
            z-index: 1001;
            background: rgba(44, 36, 24, 0.95);
            border: 2px solid #8b7355;
            border-radius: 8px;
            color: #d4c5a9;
            padding: 8px 12px;
            cursor: pointer;
            font-family: inherit;
            font-size: 13px;
            display: none;
        }

        #collapse-btn:hover {
            background: rgba(60, 48, 30, 0.95);
        }

        /* Custom marker styles */
        .event-marker {
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.5), 0 0 10px rgba(0, 0, 0, 0.3);
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            font-size: 12px;
            line-height: 1;
        }

        .event-marker:hover {
            transform: scale(1.3);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.6), 0 0 20px rgba(255, 255, 255, 0.2);
        }

        /* Popup styling */
        .leaflet-popup-content-wrapper {
            background: rgba(44, 36, 24, 0.97);
            color: #d4c5a9;
            border: 2px solid #8b7355;
            border-radius: 8px;
            font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, Georgia, serif;
        }

        .leaflet-popup-tip {
            background: rgba(44, 36, 24, 0.97);
            border: 1px solid #8b7355;
        }

        .leaflet-popup-close-button {
            color: #d4c5a9 !important;
        }

        .popup-title {
            font-size: 15px;
            font-weight: bold;
            color: #e8d9b0;
            margin-bottom: 6px;
        }

        .popup-book {
            font-size: 11px;
            color: #a89070;
            margin-bottom: 6px;
            font-style: italic;
        }

        .popup-description {
            font-size: 13px;
            line-height: 1.5;
            color: #c8b898;
        }

        .popup-characters {
            font-size: 11px;
            color: #a89070;
            margin-top: 8px;
            border-top: 1px solid #6b5b45;
            padding-top: 6px;
        }

        /* Leaflet controls theming */
        .leaflet-control-zoom a {
            background: rgba(44, 36, 24, 0.95) !important;
            color: #d4c5a9 !important;
            border-color: #8b7355 !important;
        }

        .leaflet-control-zoom a:hover {
            background: rgba(60, 48, 30, 0.95) !important;
        }

        /* Scrollbar styling for legend */
        #legend::-webkit-scrollbar {
            width: 6px;
        }

        #legend::-webkit-scrollbar-track {
            background: transparent;
        }

        #legend::-webkit-scrollbar-thumb {
            background: #8b7355;
            border-radius: 3px;
        }

        /* Journey paths — marching ants */
        @keyframes march {
            to { stroke-dashoffset: -20; }
        }

        .journey-path {
            animation: march 0.67s linear infinite;
        }

        /* Journey legend section */
        .legend-divider {
            border: none;
            border-top: 1px solid #8b7355;
            margin: 10px 0 8px;
        }

        .legend-journeys-title {
            font-size: 12px;
            color: #a89070;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 6px;
        }

        .journey-toggle {
            display: flex;
            align-items: center;
            padding: 5px 0;
            cursor: pointer;
            user-select: none;
            transition: color 0.2s;
        }

        .journey-toggle:hover {
            color: #f0e6cc;
        }

        .journey-toggle.disabled {
            opacity: 0.4;
        }

        .journey-line {
            width: 24px;
            height: 3px;
            margin-right: 8px;
            flex-shrink: 0;
            border-top: 3px dashed;
        }

        .journey-label {
            font-size: 12px;
        }

        .coord-toggle-row {
            display: flex;
            align-items: center;
            padding: 8px 0 4px;
            cursor: pointer;
            user-select: none;
        }

        .coord-toggle-switch {
            width: 32px;
            height: 18px;
            border-radius: 9px;
            background: #5a4a36;
            position: relative;
            margin-right: 8px;
            flex-shrink: 0;
            transition: background 0.2s;
        }

        .coord-toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: #8b7355;
            transition: transform 0.2s, background 0.2s;
        }

        .coord-toggle-row.active .coord-toggle-switch {
            background: #6a9f5b;
        }

        .coord-toggle-row.active .coord-toggle-switch::after {
            transform: translateX(14px);
            background: #d4c5a9;
        }

        .coord-toggle-label {
            font-size: 12px;
            color: #a89070;
            transition: color 0.2s;
        }

        .coord-toggle-row.active .coord-toggle-label {
            color: #d4c5a9;
        }

        /* Instructions toast */
        #toast {
            position: absolute;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            background: rgba(44, 36, 24, 0.92);
            border: 1px solid #8b7355;
            border-radius: 8px;
            padding: 10px 20px;
            color: #d4c5a9;
            font-size: 13px;
            opacity: 1;
            transition: opacity 1s ease;
            pointer-events: none;
            text-align: center;
        }

        #toast.hidden {
            opacity: 0;
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <div id="legend">
        <h2>Events of Middle-earth</h2>
        <div id="legend-content"></div>
    </div>

    <button id="collapse-btn">Show Legend</button>

    <div id="toast">Scroll to zoom &middot; Drag to pan &middot; Click markers for details</div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // ── Map Dimensions ──────────────────────────────
        const IMG_W = 7680;
        const IMG_H = 4386;

        // ── Category Colors ─────────────────────────────
        const COLORS = {
            silmarillion: '#9b59b6',
            hobbit:       '#5b8fb9',
            fellowship:   '#c9a435',
            towers:       '#b85c38',
            king:         '#6a9f5b',
            appendix:     '#7f8c8d'
        };

        const CATEGORY_LABELS = {
            silmarillion: 'The Silmarillion',
            hobbit:       'The Hobbit',
            fellowship:   'The Fellowship of the Ring',
            towers:       'The Two Towers',
            king:         'The Return of the King',
            appendix:     'Appendices'
        };

        const CATEGORY_ICONS = {
            silmarillion: '\u2756',
            hobbit:       '\u2302',
            fellowship:   '\u2727',
            towers:       '\u2694',
            king:         '\u2655',
            appendix:     '\u2637'
        };

        // ── Event Data ──────────────────────────────────
        // Pixel positions (origin top-left) converted to Leaflet [lat, lng]
        // lat = IMG_H - py, lng = px
        const events = [
            // ── The Silmarillion ──
            {
                name: "The Grey Havens — Mithlond",
                category: 'silmarillion',
                px: 2266, py: 1150,
                description: "Founded by C\u00edrdan the Shipwright after the War of Wrath destroyed Beleriand, the Grey Havens became the chief port from which the Elves departed Middle-earth for the Undying Lands. It was from here that Gandalf, Frodo, Bilbo, Galadriel, and Elrond sailed at the end of the Third Age.",
                characters: "C\u00edrdan, Gil-galad, Galadriel"
            },
            {
                name: "Ered Luin — Nogrod & Belegost",
                category: 'silmarillion',
                px: 2192, py: 824,
                description: "The Blue Mountains housed the great Dwarven cities of Nogrod and Belegost in the First Age. The Dwarves of Nogrod crafted the Nauglam\u00edr and later sacked Doriath to reclaim it. After the ruin of Beleriand, many Dwarves migrated east to Khazad-d\u00fbm.",
                characters: "Durin's Folk, the Firebeards, the Broadbeams"
            },
            {
                name: "Eregion — The Rings of Power",
                category: 'silmarillion',
                px: 3885, py: 1520,
                description: "In the land of Holly near the West-gate of Moria, Celebrimbor and the Gwaith-i-M\u00edrdain were deceived by Sauron in his fair guise of Annatar, 'Lord of Gifts.' Together they forged the Rings of Power. When Sauron forged the One Ring, the Elves perceived his treachery. Sauron destroyed Eregion and slew Celebrimbor.",
                characters: "Celebrimbor, Sauron (as Annatar), Elrond"
            },
            {
                name: "Khazad-d\u00fbm — The Awakening of Durin",
                category: 'silmarillion',
                px: 4000, py: 1490,
                description: "Durin the Deathless, eldest of the seven Fathers of the Dwarves, awoke at Mount Gundabad and wandered south to the Mirrormere. There he founded Khazad-d\u00fbm, the greatest mansion of the Dwarves, which endured through all the ages until the Balrog was awakened in its depths.",
                characters: "Durin the Deathless"
            },
            {
                name: "Gladden Fields — The Disaster of the Gladden Fields",
                category: 'silmarillion',
                px: 4400, py: 1360,
                description: "Two years after the defeat of Sauron, Isildur and his company were ambushed by Orcs while marching north along the Anduin. Isildur put on the One Ring to escape, but it slipped from his finger in the river and he was slain by Orc arrows. The Ring was lost for nearly 2,500 years.",
                characters: "Isildur, Ohtar"
            },
            {
                name: "Dagorlad — The Last Alliance",
                category: 'silmarillion',
                px: 5100, py: 2220,
                description: "The Last Alliance of Elves and Men, led by Gil-galad and Elendil, fought the greatest battle of the Second Age on the plains before the Black Gate. After seven years besieging Barad-d\u00fbr, they overthrew Sauron, but both Gil-galad and Elendil fell. Isildur cut the One Ring from Sauron's hand.",
                characters: "Gil-galad, Elendil, Isildur, An\u00e1rion, Elrond, Sauron"
            },
            {
                name: "Barad-d\u00fbr — The Dark Tower",
                category: 'silmarillion',
                px: 5613, py: 2466,
                description: "Sauron began building his fortress in Mordor around SA 1000, using the power of the One Ring. The Dark Tower was besieged and thrown down by the Last Alliance, but because it was built with the Ring's power, it could not be fully destroyed while the Ring endured. Sauron rebuilt it when he returned to Mordor in the Third Age.",
                characters: "Sauron, the Nazg\u00fbl"
            },
            {
                name: "Mount Doom — The Forging of the One Ring",
                category: 'silmarillion',
                px: 5440, py: 2510,
                description: "In the fires of Orodruin, Sauron forged the One Ring to control all the other Rings of Power: 'One Ring to rule them all, One Ring to find them, One Ring to bring them all, and in the darkness bind them.' The moment he put it on, the Elven ring-bearers became aware of his purpose.",
                characters: "Sauron"
            },

            {
                name: "Meneltarma — The Downfall of N\u00famenor",
                category: 'silmarillion',
                px: 229, py: 3749,
                description: "Meneltarma, the Pillar of the Heavens, was the sacred mountain at the heart of N\u00famenor. When King Ar-Pharaz\u00f4n the Golden sailed with a great armada against Valinor, Eru Il\u00favatar broke and changed the world. N\u00famenor was swallowed by the sea, and the Undying Lands were removed from the circles of the world forever. Only the Faithful, led by Elendil and his sons, escaped to found the kingdoms of Arnor and Gondor.",
                characters: "Ar-Pharaz\u00f4n, Sauron, Elendil, Isildur, An\u00e1rion"
            },
            {
                name: "Umbar — Haven of the Corsairs",
                category: 'silmarillion',
                px: 4204, py: 3995,
                description: "Umbar was a great natural harbour far to the south, first established as a fortress by the N\u00famen\u00f3reans in the Second Age. After the Downfall, the Black N\u00famen\u00f3reans held it as a base of power hostile to Gondor. It became the stronghold of the Corsairs, who raided Gondor's coasts for centuries. Their fleet sailed north during the War of the Ring, only to be captured by Aragorn at Pelargir.",
                characters: "The Corsairs, Castamir, Aragorn"
            },

            {
                name: "Dol Guldur — The Shadow over Mirkwood",
                category: 'silmarillion',
                px: 4672, py: 1578,
                description: "Around TA 1000, Sauron took secret refuge in southern Mirkwood, building the fortress of Dol Guldur and disguising himself as 'the Necromancer.' His shadow corrupted the Greenwood, turning it dark. From here he bred evil creatures and searched for the One Ring, until the White Council drove him out in TA 2941.",
                characters: "Sauron, Gandalf, Galadriel, Saruman"
            },

            // ── Appendices ──
            {
                name: "Annu\u0301minas — Capital of Arnor",
                category: 'appendix',
                px: 2847, py: 885,
                description: "Built by Elendil on the shores of Lake Evendim after the Downfall of Nu\u0301menor, Annu\u0301minas served as the first capital of the North-kingdom of Arnor. As the Du\u0301nedain dwindled, the city was abandoned and fell into ruin. After the War of the Ring, Aragorn restored it as his northern seat of power.",
                characters: "Elendil, Aragorn"
            },
            {
                name: "Argonath — The Pillars of the Kings",
                category: 'appendix',
                px: 4511, py: 2105,
                description: "Two immense stone statues of Isildur and Ana\u0301rion stand upon either side of the Anduin, their left hands raised in warning to enemies of Gondor. Built by Ro\u0301mendacil II, the Argonath marked the northern border of Gondor. The Fellowship passed between them on their journey south from Lothlo\u0301rien.",
                characters: "Isildur, Ana\u0301rion, Ro\u0301mendacil II"
            },
            {
                name: "Brandywine Bridge — The Scouring of the Shire",
                category: 'appendix',
                px: 2974, py: 1126,
                description: "The Bridge of Stonebows, built by the kings of Arnor on the Great East Road, was the only bridge across the Brandywine and the eastern gateway to the Shire. When Frodo and company returned from the War of the Ring, they found it barricaded with spiked gates and guarded by Shirriffs under Saruman's control — their first sign the Shire had been taken over. The hobbits broke through the gates and sparked the liberation of the Shire.",
                characters: "Frodo, Sam, Merry, Pippin, Saruman"
            },
            {
                name: "Cair Andros — Island Fortress",
                category: 'appendix',
                px: 4750, py: 2515,
                description: "A fortified island in the Anduin north of Osgiliath, shaped like a great ship with its prow pointing upstream. Gondor garrisoned it to guard the northern approaches to Minas Tirith. During the War of the Ring, Sauron's forces captured the island, threatening to cut off any reinforcements from Rohan.",
                characters: "Faramir, the garrison of Gondor"
            },
            {
                name: "Carn Du\u0302m — Fortress of Angmar",
                category: 'appendix',
                px: 3374, py: 357,
                description: "The iron fortress of Carn Du\u0302m was the capital of Angmar, the realm the Witch-king founded around TA 1300 with the sole purpose of destroying the Du\u0301nedain of the North. For nearly 700 years, Angmar waged war against the successor kingdoms of Arnor, eventually destroying all three.",
                characters: "The Witch-king"
            },
            {
                name: "Dol Amroth — City of the Swan Knights",
                category: 'appendix',
                px: 3702, py: 2892,
                description: "The coastal stronghold of Dol Amroth was the seat of the Princes of Belfalas, who claimed descent from the Elves. Prince Imrahil led the renowned Swan Knights to the defence of Minas Tirith, and his company was among the most valiant at the Battle of the Pelennor Fields. He ruled Gondor briefly after Denethor's death.",
                characters: "Imrahil, Galador"
            },
            {
                name: "Dorwinion — Land of Wines",
                category: 'appendix',
                px: 5964, py: 1428,
                description: "A wine-producing region on the northwestern shores of the Sea of Rhûn, Dorwinion was famed for its heady vintages. Barrels of Dorwinion wine were shipped to Thranduil's Halls in Mirkwood — and it was these potent wines that made the Elven-king's guards fall asleep, allowing Bilbo to engineer the Dwarves' escape in barrels.",
                characters: "Bilbo, Thranduil's butler"
            },
            {
                name: "Field of Celebrant — Birth of Rohan",
                category: 'appendix',
                px: 4310, py: 1723,
                description: "In TA 2510, a great host of Easterlings invaded Gondor and pushed its armies back to the Field of Celebrant. In Gondor's darkest hour, Eorl the Young rode south from the far north with his entire people, the E\u0301otheo\u0301d, and routed the invaders. In gratitude, Steward Cirion granted Eorl the province of Calenardhon, which became Rohan.",
                characters: "Eorl the Young, Cirion"
            },
            {
                name: "Fords of Isen — Death of The\u0301odred",
                category: 'appendix',
                px: 3700, py: 2104,
                description: "The Fords of Isen were the main crossing of the River Isen and a key strategic point between Rohan and Isengard. Saruman's forces attacked the Fords twice. In the first battle, The\u0301odred, son of King The\u0301oden and heir to Rohan, was slain\u2014an event that plunged the kingdom into crisis and left it leaderless as war approached.",
                characters: "The\u0301odred, Grimbold, E\u0301omer"
            },
            {
                name: "Gap of Rohan",
                category: 'appendix',
                px: 3742, py: 2135,
                description: "The wide pass between the southern end of the Misty Mountains and the northern end of the White Mountains, the Gap of Rohan was the only major land route between Eriador and Gondor that avoided mountain crossings. Saruman's control of Isengard at its northern end made the Gap a contested corridor throughout the War of the Ring.",
                characters: "Saruman"
            },
            {
                name: "Fornost — Fall of the North-kingdom",
                category: 'appendix',
                px: 3111, py: 866,
                description: "Fornost Erain, the Norbury of the Kings, became the capital of Arthedain after Annu\u0301minas was abandoned. In TA 1974 the Witch-king of Angmar overran the city and destroyed Arthedain. A year later, a combined force from Gondor, Lindon, and Rivendell defeated the Witch-king at the Battle of Fornost\u2014but too late to save the kingdom.",
                characters: "Arvedui, Ea\u0308rnur, Gl\u00f3rfindel, the Witch-king"
            },
            {
                name: "Forochel — The Last King of Arthedain",
                category: 'appendix',
                px: 2572, py: 266,
                description: "After the fall of Fornost, King Arvedui fled north to the Ice Bay of Forochel, where the Lossoth (Snowmen) sheltered him. Ci\u0301rdan sent a ship to rescue him, but it was crushed in the ice and Arvedui drowned. With him were lost two of the seven Palanti\u0301ri, sinking beneath the frozen waters forever.",
                characters: "Arvedui, the Lossoth, Ci\u0301rdan"
            },
            {
                name: "Himling — Remnant of Beleriand",
                category: 'appendix',
                px: 1202, py: 752,
                description: "A small island in the northwestern sea, Himling is the surviving peak of the great hill of Himring. In the First Age, Maedhros son of Fëanor fortified Himring as the anchor of his defensive line against Morgoth. When Beleriand was broken and drowned in the War of Wrath, the summit endured above the waves. By the Third Age it is a barren, uninhabited island — a silent monument to the wars and kingdoms long lost beneath the sea.",
                characters: "Maedhros, Fëanor"
            },
            {
                name: "Iron Hills — Realm of Da\u0301in Ironfoot",
                category: 'appendix',
                px: 6154, py: 794,
                description: "The Iron Hills were a Dwarven stronghold east of Erebor, ruled by Da\u0301in Ironfoot of Durin's line. When word reached him of Thorin's reclaiming of Erebor, Da\u0301in marched with 500 Dwarves and arrived just in time for the Battle of Five Armies. After Thorin's death, Da\u0301in became King under the Mountain.",
                characters: "Da\u0301in Ironfoot, Na\u0301in"
            },
            {
                name: "Last Bridge — The Elf-stone",
                category: 'appendix',
                px: 3681, py: 1154,
                description: "The Last Bridge crossed the River Hoarwell (Mitheithel) on the Great East Road — the last bridge before Rivendell. After the attack on Weathertop, Aragorn led the wounded Frodo and the hobbits here, fearing a Nazgûl ambush. Instead he found a pale green beryl set upon the bridge — a sign from Glorfindel that the crossing was safe and the Black Riders had been driven off.",
                characters: "Aragorn, Frodo, Sam, Merry, Pippin, Glorfindel"
            },
            {
                name: "Mountains of the East — The Orocarni",
                category: 'appendix',
                px: 7252, py: 2538,
                description: "The Orocarni, or Red Mountains, formed the eastern boundary of Middle-earth in the earliest ages. In Tolkien's cosmology, four of the seven Dwarf clans — the Ironfists, Stiffbeards, Blacklocks, and Stonefoots — awoke at sites in or near these mountains. The Blue Wizards, Alatar and Pallando, were sent east and may have worked among the peoples of these distant lands to counter Sauron's influence.",
                characters: "Alatar, Pallando (Blue Wizards)"
            },
            {
                name: "Near Harad — Realm of the Southrons",
                category: 'appendix',
                px: 5229, py: 3697,
                description: "The northern lands of the Haradrim, or Southrons, who were long enemies of Gondor. They fought alongside Sauron in the War of the Ring, riding great Mûmakil (Oliphaunts) into battle at the Pelennor Fields. In Ithilien, Sam witnesses a skirmish between Faramir's rangers and a Haradrim column and reflects on the humanity of a fallen Southron warrior.",
                characters: "The Haradrim, Faramir, Sam"
            },
            {
                name: "Northern Waste — Forodwaith",
                category: 'appendix',
                px: 4212, py: 205,
                description: "The vast frozen wasteland of Forodwaith stretched across the entire far north of Middle-earth. In the First Age it lay in the shadow of Morgoth's fortress of Angband, and an unnatural cold lingered long after his defeat. Few dared enter these lands — only the Lossoth (Snowmen of Forochel) survived on its western fringes. Dragons bred in the Withered Heath on its southern border, and the remnants of Morgoth's Iron Mountains may have endured in the furthest north.",
                characters: "The Lossoth, Morgoth"
            },
            {
                name: "Sea of Núrnen — The Slave Lands",
                category: 'appendix',
                px: 5836, py: 2972,
                description: "An inland sea in southern Mordor, fed by rivers flowing down from the Ephel Dúath and Ash Mountains. The fertile lands of Nurn surrounding it were tended by vast armies of slaves who grew food to feed Sauron's war machine. After the fall of Barad-dûr, King Elessar freed the slaves and granted them the lands of Nurn as their own.",
                characters: "Aragorn (Elessar), the slaves of Nurn"
            },
            {
                name: "Sea of Rhûn — Waters of the East",
                category: 'appendix',
                px: 6164, py: 1684,
                description: "A vast inland sea in the far east of Middle-earth, the Sea of Rhûn was the heartland of the Easterling peoples who repeatedly invaded Gondor throughout the ages. Little is known of the lands beyond it. The Blue Wizards, Alatar and Pallando, were sent east and are believed to have journeyed beyond the sea, but their fate remains unknown.",
                characters: "The Easterlings, Alatar, Pallando"
            },
            {
                name: "River-folk — The Origin of Gollum",
                category: 'appendix',
                px: 4434, py: 1380,
                description: "In the upper vales of the Anduin, near the Gladden River, lived a small community of Stoors — a hobbit-like river-folk. It was here that Déagol found the One Ring while fishing, and his cousin Sméagol murdered him to possess it. Corrupted by the Ring over five centuries, Sméagol became the wretched creature Gollum, eventually retreating to the roots of the Misty Mountains. The Ring's long journey from Isildur's loss at the Gladden Fields to Bilbo's finding it in Gollum's cave began in these quiet woods.",
                characters: "Sméagol (Gollum), Déagol"
            },
            {
                name: "Sarn Ford — The Breach of the Shire",
                category: 'appendix',
                px: 3025, py: 1444,
                description: "The main southern ford across the Brandywine River, Sarn Ford was secretly guarded by Aragorn's Rangers to protect the Shire — a service the hobbits never knew about. In September TA 3018, the Nazgûl forced the crossing, scattering the Dúnedain and entering the Shire to hunt for 'Baggins.' This breach of the Shire's invisible defences set the entire chase in motion.",
                characters: "The Nazgûl, the Rangers of the North, Aragorn"
            },
            {
                name: "Tharbad — Crossing of the Greyflood",
                category: 'appendix',
                px: 3359, py: 1541,
                description: "Once a thriving trade town at the crossing of the Greyflood on the North-South Road, Tharbad fell into ruin as both Arnor and Gondor declined. By the time of the War of the Ring, only crumbling walls remained. Boromir lost his horse fording the river here on his long journey from Minas Tirith to Rivendell, and had to continue on foot.",
                characters: "Boromir"
            },
            {
                name: "Tol Fuin — Remnant of Dorthonion",
                category: 'appendix',
                px: 747, py: 874,
                description: "An island in the far northwestern sea, Tol Fuin is the surviving highland of Dorthonion (Taur-nu-Fuin). In the First Age, this forested plateau was held by Angrod and Aegnor against Morgoth until the Dagor Bragollach. Afterwards it became a haunted wilderness where Barahir and his outlaws hid, and where his son Beren wandered alone before escaping south to Doriath and his fateful meeting with Lúthien. When Beleriand was drowned, only this peak endured above the waves.",
                characters: "Barahir, Beren, Angrod, Aegnor"
            },
            {
                name: "Tol Morwen — The Gravestone Isle",
                category: 'appendix',
                px: 334, py: 1094,
                description: "The smallest of the island remnants of Beleriand. In the First Age, Túrin Turambar and his mother Morwen were buried together beneath a great stone on the mound of the slain near the ruined halls of Nargothrond. When Beleriand was drowned in the War of Wrath, the gravestone alone stood above the waves — an island bearing the names of Túrin and Nienor, a last testament to the tragic children of Húrin.",
                characters: "Túrin Turambar, Morwen, Nienor, Húrin"
            },
            {
                name: "Tower Hills — The Elostirion Stone",
                category: 'appendix',
                px: 2386, py: 1159,
                description: "The Tower Hills (Emyn Beraid) stood between the Shire and the Grey Havens, crowned by the tall white tower of Elostirion. It housed one of the three Palantíri given to the North-kingdom — but unlike the others, this stone looked only west, toward the Undying Lands across the sea. It was kept by the Elves of Lindon and taken aboard the last ship from the Grey Havens.",
                characters: "Elendil, Gil-galad"
            },
            {
                name: "Withered Heath — The Dragon Lands",
                category: 'appendix',
                px: 5020, py: 488,
                description: "The Withered Heath lay between the arms of the Grey Mountains in the far north, and was the breeding ground of the great dragons. It was from here that Smaug descended upon Erebor in TA 2770, driving the Dwarves into exile. Other dragons from the Heath had previously attacked the Grey Mountains, slaying King Da\u0301in I.",
                characters: "Smaug, Da\u0301in I"
            },

            // ── The Hobbit ──
            {
                name: "Bag End — An Unexpected Party",
                category: 'hobbit',
                px: 2746, py: 1115,
                description: "Gandalf and thirteen Dwarves led by Thorin Oakenshield arrive uninvited at Bilbo Baggins' hobbit-hole, recruiting the bewildered hobbit as their burglar for a quest to reclaim the Lonely Mountain from the dragon Smaug.",
                characters: "Bilbo, Gandalf, Thorin, Balin, Dwalin, F\u00edli, K\u00edli, and company"
            },
            {
                name: "The Trollshaws — Three Trolls",
                category: 'hobbit',
                px: 3811, py: 937,
                description: "The company encounters three Stone-trolls\u2014Tom, Bert, and William\u2014who capture the Dwarves and plan to cook them. Gandalf tricks the trolls by mimicking their voices until dawn turns them to stone.",
                characters: "Bilbo, Gandalf, Thorin, the Trolls"
            },
            {
                name: "Rivendell — The Moon Letters",
                category: 'hobbit',
                px: 3922, py: 1096,
                description: "Elrond hosts the company and reads the moon letters on Thr\u00f3r's map, revealing the secret entrance to Erebor: 'Stand by the grey stone when the thrush knocks, and the last light of Durin's Day will shine upon the keyhole.'",
                characters: "Bilbo, Gandalf, Thorin, Elrond"
            },
            {
                name: "Misty Mountains — Riddles in the Dark",
                category: 'hobbit',
                px: 4094, py: 1049,
                description: "Captured by goblins in the High Pass, the company fights free, but Bilbo is separated and lost in the deep tunnels. There he discovers a golden ring and meets Gollum, defeating him in a game of riddles to find the way out.",
                characters: "Bilbo, Gollum, the Great Goblin"
            },
            {
                name: "Goblin-town / High Pass",
                category: 'hobbit',
                px: 4080, py: 1030,
                description: "The High Pass over the Misty Mountains conceals Goblin-town beneath it, a sprawling underground warren ruled by the Great Goblin. Thorin's company is captured here while sheltering from a thunder-battle, and Gandalf slays the Great Goblin to lead their escape through the tunnels.",
                characters: "Gandalf, Thorin, the Great Goblin"
            },
            {
                name: "The Carrock — Rescue by Eagles",
                category: 'hobbit',
                px: 4319, py: 976,
                description: "Pursued by Wargs and goblins, the company is trapped in trees and saved by the Great Eagles, who carry them to safety at the Carrock, a great rock in the river Anduin.",
                characters: "Bilbo, Gandalf, Thorin, the Great Eagles"
            },
            {
                name: "Beorn's Hall",
                category: 'hobbit',
                px: 4444, py: 944,
                description: "The company takes refuge with Beorn, a great skin-changer who can take the form of a bear. He confirms the goblins' pursuit and lends them ponies and provisions for the journey through Mirkwood.",
                characters: "Bilbo, Gandalf, Thorin, Beorn"
            },
            {
                name: "Mirkwood — Spiders and Shadows",
                category: 'hobbit',
                px: 4637, py: 945,
                description: "Without Gandalf, the company enters the dark forest of Mirkwood. They are ensnared by giant spiders. Bilbo uses the Ring and his Elven blade (which he names Sting) to free the Dwarves in his first true act of heroism.",
                characters: "Bilbo, Thorin, the Dwarves"
            },
            {
                name: "Dol Guldur — The White Council Strikes",
                category: 'hobbit',
                px: 4690, py: 1578,
                description: "While the Dwarves journey through Mirkwood, Gandalf departs to join the White Council in an assault on Dol Guldur. They drive out the Necromancer\u2014revealed to be Sauron himself\u2014from the fortress. This is why Gandalf is absent during the company's capture by spiders and Wood-elves.",
                characters: "Gandalf, Galadriel, Saruman, Elrond, Sauron"
            },
            {
                name: "Thranduil's Halls — The Woodland Realm",
                category: 'hobbit',
                px: 4815, py: 962,
                description: "The Wood-elves of King Thranduil capture the Dwarves and imprison them. Bilbo, invisible with the Ring, sneaks through the halls for weeks before devising an escape plan using empty barrels floated down the Forest River.",
                characters: "Bilbo, Thorin, Thranduil"
            },
            {
                name: "Lake-town — Welcome to Esgaroth",
                category: 'hobbit',
                px: 5105, py: 1125,
                description: "The company arrives at the trade town of Esgaroth on the Long Lake. Thorin declares himself King under the Mountain, and the Men of the Lake welcome the Dwarves, hoping for the return of the old prosperity foretold in legend.",
                characters: "Bilbo, Thorin, Bard, the Master of Lake-town"
            },
            {
                name: "Long Lake — The Death of Smaug",
                category: 'hobbit',
                px: 5140, py: 1125,
                description: "Enraged by Bilbo's theft, Smaug descends on Lake-town in a storm of fire, setting the town ablaze. As the dragon wheels for another pass, Bard the Bowman\u2014guided by the thrush's message about the bare patch in Smaug's jewelled armour\u2014looses the Black Arrow and strikes true. Smaug crashes down full upon the town, his last throes splintering it to sparks. The lake roars in over the ruins, swallowing the dragon forever.",
                characters: "Smaug, Bard the Bowman, Bilbo"
            },
            {
                name: "Erebor — Inside the Lonely Mountain",
                category: 'hobbit',
                px: 5161, py: 941,
                description: "Bilbo creeps down the secret passage and confronts Smaug the Golden in his vast treasure hoard. The hobbit's clever riddling conversation reveals the dragon's one weak spot\u2014a bare patch on his left breast.",
                characters: "Bilbo, Smaug, Thorin"
            },
            {
                name: "Mount Gundabad — The Goblin Horde",
                category: 'hobbit',
                px: 3842, py: 447,
                description: "An ancient Dwarven holy site where Durin first awoke, Mount Gundabad was long ago seized by Orcs. In the Battle of Five Armies, Bolg leads a vast goblin army from Gundabad to Erebor, turning what had been a standoff between Dwarves, Elves, and Men into a desperate battle for survival.",
                characters: "Bolg, Thorin, D\u00e1in Ironfoot"
            },
            {
                name: "Dale — The Battle of Five Armies",
                category: 'hobbit',
                px: 5123, py: 983,
                description: "After Bard slays Smaug, five armies converge on the Lonely Mountain: Men, Elves, Dwarves, Goblins, and Wargs. The Free Peoples unite against the goblin horde. Thorin is mortally wounded but reconciles with Bilbo before dying.",
                characters: "Thorin, Bilbo, Bard, Thranduil, D\u00e1in, Beorn, the Great Eagles"
            },

            // ── The Fellowship of the Ring ──
            {
                name: "Bag End — Bilbo's Farewell",
                category: 'fellowship',
                px: 2764, py: 1115,
                description: "Bilbo Baggins celebrates his 111th birthday with a magnificent party, then vanishes using the One Ring. He leaves the Ring to his nephew Frodo, setting the quest in motion.",
                characters: "Bilbo, Frodo, Gandalf"
            },
            {
                name: "Bucklebury Ferry — Escape from the Black Rider",
                category: 'fellowship',
                px: 2988, py: 1178,
                description: "The ferry across the Brandywine south of the Bridge, connecting the Shire to Buckland. Frodo, Sam, and Pippin race to the ferry with a Black Rider closing behind them. They push off just in time, watching the dark shape halt at the water's edge before turning away toward the Bridge.",
                characters: "Frodo, Sam, Merry, Pippin, the Nazg\u00fbl"
            },
            {
                name: "Crickhollow — The Conspiracy Unmasked",
                category: 'fellowship',
                px: 3034, py: 1204,
                description: "Frodo's house in Buckland, purchased as a cover story for leaving the Shire. Here Merry, Pippin, Sam, and Fatty Bolger reveal they have known about the Ring all along and insist on joining Frodo's journey. After the company departs into the Old Forest, a Nazgûl attacks the house at night. Fatty Bolger escapes and sounds the Horn-call of Buckland, the first time it had been blown in generations.",
                characters: "Frodo, Sam, Merry, Pippin, Fatty Bolger, the Nazgûl"
            },
            {
                name: "Old Forest — Tom Bombadil",
                category: 'fellowship',
                px: 3098, py: 1178,
                description: "Leaving the Shire through the High Hay, the hobbits enter the ancient Old Forest where Old Man Willow traps Merry and Pippin. They are rescued by Tom Bombadil, the enigmatic master of the forest, who is unaffected by the One Ring's power — one of the great mysteries of Middle-earth.",
                characters: "Frodo, Sam, Merry, Pippin, Tom Bombadil, Goldberry"
            },
            {
                name: "Barrow-downs — Blades of Westernesse",
                category: 'fellowship',
                px: 3185, py: 1144,
                description: "Crossing the ancient burial mounds, the hobbits are ensnared by a Barrow-wight. Tom Bombadil rescues them again. In the wight's hoard, they find Dúnedain swords forged to fight Angmar — it is Merry's blade that later helps slay the Witch-king at the Pelennor Fields.",
                characters: "Frodo, Sam, Merry, Pippin, Tom Bombadil, the Barrow-wight"
            },
            {
                name: "Bree — The Prancing Pony",
                category: 'fellowship',
                px: 3254, py: 1139,
                description: "Frodo and the hobbits meet the mysterious ranger Strider (Aragorn) at the Prancing Pony inn. Frodo accidentally puts on the Ring, drawing the attention of the Nazg\u00fbl.",
                characters: "Frodo, Sam, Merry, Pippin, Aragorn"
            },
            {
                name: "Weathertop — Attack of the Nazg\u00fbl",
                category: 'fellowship',
                px: 3484, py: 1097,
                description: "The Witch-king of Angmar stabs Frodo with a Morgul blade atop the ancient watchtower of Amon S\u00fbl. The wound nearly claims Frodo's life, leaving a lasting mark.",
                characters: "Frodo, Aragorn, the Nazg\u00fbl"
            },
            {
                name: "Ford of Bruinen — Flight to the Ford",
                category: 'fellowship',
                px: 3850, py: 1134,
                description: "With a Morgul wound slowly claiming his life, Frodo races on Glorfindel's horse Asfaloth toward the Ford of Bruinen, the last crossing before Rivendell. The Nine Nazg\u00fbl pursue him to the river's edge. As they enter the water, Elrond unleashes the river in a great flood shaped as white horses, sweeping the Black Riders away and breaking their pursuit at last.",
                characters: "Frodo, Glorfindel, Aragorn, the Nazg\u00fbl, Elrond, Gandalf"
            },
            {
                name: "Rivendell — The Council of Elrond",
                category: 'fellowship',
                px: 3940, py: 1096,
                description: "Representatives of the Free Peoples gather at the Last Homely House. The Fellowship of the Ring is formed: nine companions to counter the nine Nazg\u00fbl, tasked with destroying the One Ring.",
                characters: "Frodo, Gandalf, Aragorn, Legolas, Gimli, Boromir, Sam, Merry, Pippin"
            },
            {
                name: "Caradhras, Celebdil & Fanuidhol — The Redhorn Pass",
                category: 'fellowship',
                px: 3973, py: 1447,
                description: "The three peaks above Moria—Caradhras (Redhorn), Celebdil (Silvertine), and Fanuidhol (Cloudyhead)—guard the high pass the Fellowship attempts before being driven back by blizzard and malice. Their failure on the Redhorn Pass forces the fateful decision to go under the mountains through Moria.",
                characters: "Gandalf, Aragorn, the Fellowship"
            },
            {
                name: "Moria — The Bridge of Khazad-d\u00fbm",
                category: 'fellowship',
                px: 3981, py: 1515,
                description: "The Fellowship passes through the abandoned Dwarven kingdom. After discovering the fate of Balin's colony, they are attacked by Orcs and a cave troll. Gandalf confronts the Balrog on the Bridge and falls into shadow.",
                characters: "Gandalf, the Balrog, the Fellowship"
            },
            {
                name: "Dimrill Dale — The Mirrormere",
                category: 'fellowship',
                px: 4026, py: 1516,
                description: "Emerging grief-stricken from Moria after Gandalf's fall, the Fellowship pauses at the Dimrill Dale. Gimli looks into the Mirrormere (Kheled-zâram), the sacred lake where Durin the Deathless first saw a crown of stars reflected about his head, and the sight strengthens his resolve.",
                characters: "Aragorn, Legolas, Gimli, Frodo, Sam, Merry, Pippin, Boromir"
            },
            {
                name: "Lothl\u00f3rien — The Golden Wood",
                category: 'fellowship',
                px: 4214, py: 1609,
                description: "The grieving Fellowship takes refuge in the Elven realm of Lady Galadriel. She shows Frodo the Mirror of Galadriel and resists the temptation of the Ring. The company receives Elven gifts and boats.",
                characters: "Galadriel, Celeborn, the Fellowship"
            },
            {
                name: "Caras Galadhon — The Heart of Lothl\u00f3rien",
                category: 'fellowship',
                px: 4190, py: 1640,
                description: "The city of the Galadhrim, built on a great hill among the mallorn trees. Here stand the high telain of Celeborn and Galadriel, and the Mirror of Galadriel in its garden hollow. From this city the Fellowship receives the Elven cloaks, lembas, and other gifts — including the Phial of Galadriel and the three golden hairs she gives to Gimli.",
                characters: "Galadriel, Celeborn, Frodo, Gimli, the Fellowship"
            },
            {
                name: "Amon Hen — The Breaking of the Fellowship",
                category: 'fellowship',
                px: 4480, py: 2174,
                description: "Boromir succumbs to the Ring's temptation and tries to take it from Frodo. Orcs attack; Boromir redeems himself defending Merry and Pippin but is slain. Frodo and Sam depart alone for Mordor.",
                characters: "Boromir, Frodo, Aragorn, Merry, Pippin, Lurtz"
            },
            {
                name: "Rauros Falls — Boromir's Funeral",
                category: 'fellowship',
                px: 4502, py: 2196,
                description: "The great waterfall of Rauros on the Anduin, near the hills of Emyn Muil. After Boromir falls defending Merry and Pippin, Aragorn, Legolas, and Gimli place his body in an Elven boat and send it over the falls as a funeral rite — a solemn farewell to the son of Gondor.",
                characters: "Aragorn, Legolas, Gimli, Boromir"
            },

            // ── The Two Towers ──
            {
                name: "Eaves of Fangorn — Escape from the Uruk-hai",
                category: 'towers',
                px: 4029, py: 1818,
                description: "At the edge of Fangorn Forest, the Riders of Rohan under \u00c9omer surround and destroy the Uruk-hai band carrying Merry and Pippin. In the chaos of the night battle, the two hobbits slip their bonds and crawl into the eaves of the forest, where they will encounter Treebeard. Aragorn, Legolas, and Gimli arrive the next morning to find the smouldering orc pyre and track the hobbits' trail into the trees.",
                characters: "\u00c9omer, Merry, Pippin, Ugl\u00fak, Grish\u00e1kh, Aragorn, Legolas, Gimli"
            },
            {
                name: "Fangorn Forest — The White Wizard",
                category: 'towers',
                px: 4043, py: 1918,
                description: "Merry and Pippin escape the Uruk-hai and meet Treebeard the Ent. Meanwhile, Aragorn, Legolas, and Gimli encounter Gandalf reborn as Gandalf the White.",
                characters: "Gandalf, Treebeard, Merry, Pippin, Aragorn, Legolas, Gimli"
            },
            {
                name: "Edoras — The Golden Hall of Meduseld",
                category: 'towers',
                px: 3969, py: 2344,
                description: "Gandalf frees King Th\u00e9oden from the influence of Saruman, channeled through Gr\u00edma Wormtongue. The people of Rohan prepare for war against Isengard's forces.",
                characters: "Gandalf, Th\u00e9oden, \u00c9owyn, \u00c9omer, Gr\u00edma"
            },
            {
                name: "Helm's Deep — The Battle of the Hornburg",
                category: 'towers',
                px: 3760, py: 2277,
                description: "The Rohirrim make a desperate stand against Saruman's army of 10,000 Uruk-hai at the fortress of Helm's Deep. Victory comes at dawn with the charge of Gandalf and the Rohirrim, and the arrival of the Huorns.",
                characters: "Th\u00e9oden, Aragorn, Legolas, Gimli, Gandalf, Haldir"
            },
            {
                name: "Isengard — The Ents' Assault",
                category: 'towers',
                px: 3775, py: 2039,
                description: "Roused to fury by Saruman's destruction of the forest, the Ents march on Isengard and break the dam, flooding the fortress and trapping Saruman in the tower of Orthanc.",
                characters: "Treebeard, Merry, Pippin, Saruman"
            },
            {
                name: "Orthanc — The Voice of Saruman",
                category: 'towers',
                px: 3744, py: 2017,
                description: "After the flooding of Isengard, Gandalf and the company confront Saruman atop the tower of Orthanc. Saruman attempts to sway them with his persuasive voice but is broken by Gandalf, who casts him from the order. Gr\u00edma Wormtongue hurls the palant\u00edr of Orthanc from the tower. That night Pippin steals a look into the seeing-stone and is seen by Sauron \u2014 forcing Gandalf to ride at once to Minas Tirith with Pippin.",
                characters: "Gandalf, Saruman, Gr\u00edma, Pippin, Aragorn, Th\u00e9oden"
            },
            {
                name: "Emyn Muil — The Taming of Gollum",
                category: 'towers',
                px: 4740, py: 2032,
                description: "Frodo and Sam become lost in the rocky maze of Emyn Muil. They capture Gollum, who has been stalking them, and Frodo makes him swear on the Precious to serve as their guide to Mordor.",
                characters: "Frodo, Sam, Gollum"
            },
            {
                name: "The Dead Marshes",
                category: 'towers',
                px: 4894, py: 2150,
                description: "Gollum leads the hobbits through the treacherous Dead Marshes, where ghostly lights and the faces of the ancient dead lie beneath the water. A Nazg\u00fbl on a fell beast passes overhead.",
                characters: "Frodo, Sam, Gollum"
            },
            {
                name: "Henneth Annûn — Window of the Sunset",
                category: 'towers',
                px: 5029, py: 2491,
                description: "A hidden refuge of the Rangers of Ithilien behind a curtain waterfall. Faramir brings Frodo and Sam here after capturing them in the wilds of Ithilien. Behind the falls, Faramir questions Frodo about the Ring and learns of Boromir's death — and unlike his brother, chooses not to seize the Ring.",
                characters: "Faramir, Frodo, Sam, Gollum"
            },
            {
                name: "Osgiliath — Faramir's Choice",
                category: 'towers',
                px: 4856, py: 2658,
                description: "Faramir captures Frodo and Sam and brings them to Osgiliath. Unlike his brother Boromir, Faramir ultimately resists the Ring's pull and releases the hobbits to continue their quest.",
                characters: "Faramir, Frodo, Sam, Gollum"
            },

            // ── The Return of the King ──
            {
                name: "Minas Morgul — The Dead City",
                category: 'king',
                px: 5033, py: 2660,
                description: "The hobbits pass the dread city of Minas Morgul, once Minas Ithil, now home to the Witch-king and his Nazg\u00fbl. As they climb the stairs beside it, the army of Morgul issues forth, led by the Witch-king, marching to war against Gondor.",
                characters: "Frodo, Sam, Gollum, the Witch-king"
            },
            {
                name: "Cirith Ungol — Shelob's Lair",
                category: 'king',
                px: 5106, py: 2544,
                description: "Gollum's treachery is revealed as he leads the hobbits into the lair of the giant spider Shelob. Frodo is stung and paralyzed. Sam drives Shelob away with the Phial of Galadriel and Sting, then rescues Frodo from the tower of Cirith Ungol.",
                characters: "Frodo, Sam, Gollum, Shelob"
            },
            {
                name: "Tower of Cirith Ungol — Sam's Rescue",
                category: 'king',
                px: 5120, py: 2530,
                description: "After Shelob stings Frodo, the orcs of the tower carry his body inside. Sam, believing Frodo dead, takes the Ring \u2014 but overhears the orcs and realises Frodo is alive. He storms the tower alone, finding the garrison has slaughtered itself in a quarrel over Frodo's mithril coat. Sam returns the Ring and the two hobbits escape disguised as orcs into Mordor.",
                characters: "Sam, Frodo, Shagrat, Gorbag"
            },
            {
                name: "Dunharrow — Muster of Rohan",
                category: 'king',
                px: 4005, py: 2440,
                description: "A mountain refuge on a sheer cliff above Harrowdale, reached by a switchback path lined with ancient Púkel-men statues. The Rohirrim muster here before riding to Gondor's aid. Behind the Firienfeld lies the Dark Door — entrance to the Paths of the Dead, which Aragorn alone dares to enter.",
                characters: "Théoden, Éowyn, Merry, Aragorn"
            },
            {
                name: "Erech — The Paths of the Dead",
                category: 'king',
                px: 3886, py: 2470,
                description: "Aragorn, Legolas, and Gimli ride the Paths of the Dead beneath the White Mountains and emerge at the Stone of Erech. There Aragorn, as heir of Isildur, summons the oathbreaking Dead Men of Dunharrow to fulfil their ancient pledge. The ghostly army follows him south to overwhelm the Corsairs of Umbar, seizing their ships to sail up the Anduin to the Pelennor Fields.",
                characters: "Aragorn, Legolas, Gimli, the Dead Men of Dunharrow"
            },
            {
                name: "Paths of the Dead — The Haunted Way",
                category: 'king',
                px: 3945, py: 2458,
                description: "A dread passage beneath the White Mountains connecting Dunharrow to the vale beyond. The Dead Men who broke their oath to Isildur haunt its darkness. None had dared enter for centuries until Aragorn, as Isildur's heir, rode through with Legolas, Gimli, and the Grey Company, commanding the Dead to follow and fulfil their ancient pledge.",
                characters: "Aragorn, Legolas, Gimli, the Grey Company, the Dead Men"
            },
            {
                name: "Lamedon — Angbor's Rally",
                category: 'king',
                px: 4125, py: 2795,
                description: "A valley fiefdom of Gondor on the southern slopes of the White Mountains, along the River Ciril. After Aragorn emerged from the Paths of the Dead and routed the Corsairs at Pelargir, Lord Angbor of Lamedon rallied his men and joined Aragorn's force sailing up the Anduin to relieve Minas Tirith at the Battle of the Pelennor Fields.",
                characters: "Angbor, Aragorn"
            },
            {
                name: "White Mountains — Ered Nimrais",
                category: 'appendix',
                px: 4253, py: 2607,
                description: "The great mountain range running east to west between Rohan and Gondor. Beneath its peaks lie the Paths of the Dead, and along its northern feet stand Edoras, Dunharrow, and Helm's Deep. Its eastern end overlooks Minas Tirith and the Pelennor Fields. The beacons of Gondor are lit along its summits to call Rohan to war.",
                characters: "Th\u00e9oden, Aragorn"
            },
            {
                name: "Minas Tirith — The Siege of Gondor",
                category: 'king',
                px: 4720, py: 2641,
                description: "Sauron's forces besiege the White City. The Witch-king breaks the Great Gate. Denethor, driven mad by the palant\u00edr, attempts to burn Faramir alive. The Rohirrim arrive at dawn to turn the tide.",
                characters: "Gandalf, Denethor, Faramir, Pippin"
            },
            {
                name: "Pelargir — Capture of the Corsair Fleet",
                category: 'king',
                px: 4509, py: 2977,
                description: "Aragorn leads the Army of the Dead south from Erech to the ancient port of Pelargir, where the Corsairs of Umbar have anchored their fleet. The Dead sweep through the Corsairs in terror, and Aragorn seizes the ships. He then sails up the Anduin with reinforcements from southern Gondor, arriving at the Pelennor Fields to turn the tide of battle.",
                characters: "Aragorn, Legolas, Gimli, the Dead Men of Dunharrow, the Corsairs of Umbar"
            },
            {
                name: "Drúadan Forest — The Wild Men",
                category: 'king',
                px: 4618, py: 2531,
                description: "When the road to Minas Tirith is blocked by Sauron's forces, Ghân-buri-Ghân of the Drúedain (Wild Men) guides the Rohirrim through secret paths in the ancient forest, allowing them to reach the Pelennor Fields in time. In gratitude, Aragorn later grants the Drúadan Forest to the Wild Men forever.",
                characters: "Ghân-buri-Ghân, Théoden, Éomer, Merry"
            },
            {
                name: "Pelennor Fields — The Great Battle",
                category: 'king',
                px: 4784, py: 2638,
                description: "The greatest battle of the War of the Ring. Th\u00e9oden leads the Rohirrim charge. \u00c9owyn and Merry slay the Witch-king. Aragorn arrives with the Army of the Dead to rout Sauron's forces.",
                characters: "Th\u00e9oden, \u00c9owyn, Merry, Aragorn, the Witch-king"
            },
            {
                name: "The Black Gate — The Last Debate",
                category: 'king',
                px: 5141, py: 2272,
                description: "Aragorn leads the armies of the West to the Black Gate of Mordor in a desperate gambit to draw Sauron's Eye away from Frodo. Vastly outnumbered, they fight to buy time for the Ring-bearer.",
                characters: "Aragorn, Gandalf, Legolas, Gimli, Merry, Pippin"
            },
            {
                name: "Mount Doom — The End of All Things",
                category: 'king',
                px: 5419, py: 2532,
                description: "Frodo and Sam reach the Crack of Doom after an agonizing journey across Mordor. At the last moment, Frodo claims the Ring\u2014but Gollum bites it from his finger and falls into the fire, destroying the One Ring and Sauron forever.",
                characters: "Frodo, Sam, Gollum"
            },
            {
                name: "Field of Cormallen — The Eagles Are Coming",
                category: 'king',
                px: 4799, py: 2565,
                description: "After the destruction of the Ring, Gandalf rides the great Eagle Gwaihir to rescue Frodo and Sam from the slopes of Mount Doom. They awake in Ithilien to find Gandalf at their bedside. The Host of the West honours the hobbits before the gates of the field, and Aragorn bows to them, saying 'Praise them with great praise!'",
                characters: "Frodo, Sam, Gandalf, Aragorn, Gwaihir"
            },
            {
                name: "Minas Tirith — The Coronation of Elessar",
                category: 'king',
                px: 4730, py: 2650,
                description: "Aragorn is crowned King Elessar on the plain before Minas Tirith. Gandalf sets the White Crown upon his head, and Aragorn speaks the words of Elendil: 'Et E\u00e4rello Endorenna ut\u00falien.' At the city gate Arwen awaits him, and they are wed at last \u2014 the union of the lines of Elros and Elrond, long sundered.",
                characters: "Aragorn, Arwen, Gandalf, Faramir, \u00c9owyn"
            },
            {
                name: "Mindolluin — The White Tree",
                category: 'king',
                px: 4740, py: 2665,
                description: "Gandalf leads Aragorn up the slopes of Mount Mindolluin above Minas Tirith. In a high hallow of snow they find a sapling of the White Tree, descended from Nimloth of N\u00famenor and ultimately from Telperion, the eldest of Trees. Aragorn plants it in the Court of the Fountain, where it flowers \u2014 a sign that his kingdom will endure.",
                characters: "Aragorn, Gandalf"
            },
            {
                name: "Bywater — The Scouring of the Shire",
                category: 'king',
                px: 2848, py: 1147,
                description: "Returning home, the four hobbits find the Shire under the tyranny of 'Sharkey' \u2014 Saruman, diminished but vengeful. Merry and Pippin rouse the Shire-folk, and at the Battle of Bywater the ruffians are overthrown. Frodo confronts Saruman at Bag End and offers mercy, but Gr\u00edma Wormtongue turns on his master and slays him. It is the last killing in the War of the Ring.",
                characters: "Frodo, Sam, Merry, Pippin, Saruman, Gr\u00edma"
            },
            {
                name: "Westmarch — The Red Book",
                category: 'king',
                px: 2524, py: 1019,
                description: "After the War of the Ring, King Elessar granted the hobbits the land between the Far Downs and the Tower Hills, extending the Shire westward. This region became the Westmarch. Sam's eldest daughter Elanor and her husband Fastred of Greenholm settled here as Wardens of Westmarch. The Red Book of Westmarch \u2014 the in-universe manuscript from which The Lord of the Rings is said to be copied \u2014 was kept by their descendants in this land.",
                characters: "Elanor, Fastred, Samwise Gamgee"
            }
        ];

        // ── Helper: pixel coords → Leaflet coords ──────
        function toLatLng(px, py) {
            return [py, px];
        }

        // ── Map Setup ───────────────────────────────────
        const MapCRS = L.Util.extend({}, L.CRS.Simple, {
            transformation: new L.Transformation(1, 0, 1, 0)
        });

        const map = L.map('map', {
            crs: MapCRS,
            minZoom: -4,
            maxZoom: 3,
            zoomSnap: 0.25,
            zoomDelta: 0.5,
            wheelPxPerZoomLevel: 120,
            attributionControl: false
        });

        const bounds = [[0, 0], [IMG_H, IMG_W]];
        L.tileLayer('tiles/{z}/{x}/{y}.jpg', {
            minZoom: -4,
            maxZoom: 3,
            maxNativeZoom: 0,
            minNativeZoom: -2,
            zoomOffset: 2,
            tileSize: 256,
            noWrap: true,
            bounds: bounds
        }).addTo(map);
        map.fitBounds(bounds);
        const PAD = Math.max(IMG_W, IMG_H);
        map.setMaxBounds([[-PAD, -PAD], [IMG_H + PAD, IMG_W + PAD]]);

        // ── Create Markers ──────────────────────────────
        const categoryLayers = {
            silmarillion: L.layerGroup(),
            hobbit: L.layerGroup(),
            fellowship: L.layerGroup(),
            towers: L.layerGroup(),
            king: L.layerGroup(),
            appendix: L.layerGroup()
        };

        events.forEach(evt => {
            const latlng = toLatLng(evt.px, evt.py);
            const color = COLORS[evt.category];
            const icon = L.divIcon({
                className: '',
                html: `<div class="event-marker" style="
                    width: 22px; height: 22px;
                    background: radial-gradient(circle at 35% 35%, ${color}, ${darken(color, 40)});
                ">${CATEGORY_ICONS[evt.category]}</div>`,
                iconSize: [22, 22],
                iconAnchor: [11, 11],
                popupAnchor: [0, -14]
            });

            const marker = L.marker(latlng, { icon })
                .bindPopup(`
                    <div style="max-width: 260px;">
                        <div class="popup-title">${evt.name}</div>
                        <div class="popup-book">${CATEGORY_LABELS[evt.category]}</div>
                        <div class="popup-description">${evt.description}</div>
                        <div class="popup-characters"><strong>Key figures:</strong> ${evt.characters}</div>
                    </div>
                `, { maxWidth: 300 });

            marker._eventData = evt;
            categoryLayers[evt.category].addLayer(marker);
        });

        Object.values(categoryLayers).forEach(layer => layer.addTo(map));

        // ── Journey Paths ──────────────────────────────
        // Shared Fellowship path: Rivendell to Rauros Falls
        const FELLOWSHIP_PATH = [
            [3940, 1096],  // Rivendell
            [3930, 1190],  // South from Rivendell
            [3915, 1280],  // Western foothills
            [3900, 1370],  // Hollin (Eregion)
            [3930, 1440],  // Approaching Caradhras
            [3981, 1515],  // Moria
            [4026, 1516],  // Dimrill Dale
            [4214, 1609],  // Lothlórien
            [4322, 1650],  // Anduin
            [4371, 1684],  // Anduin
            [4366, 1719],  // Anduin
            [4469, 1712],  // Anduin
            [4463, 1801],  // Anduin
            [4576, 1817],  // Anduin
            [4541, 1905],  // Anduin
            [4569, 1985],  // Anduin
            [4511, 2105],  // Argonath
            [4480, 2174],  // Amon Hen
            [4502, 2196]   // Rauros Falls
        ];

        const JOURNEYS = {
            fellowship: {
                label: "The Fellowship",
                color: '#7b2d8e',
                points: FELLOWSHIP_PATH
            },
            bilbo: {
                label: "Bilbo's Journey",
                color: '#5b8fb9',
                points: [
                    [2746, 1115],  // Bag End
                    [2974, 1126],  // Brandywine Bridge
                    [3811, 937],   // Trollshaws
                    [3922, 1096],  // Rivendell
                    [4094, 1049],  // Misty Mountains
                    [4319, 976],   // Carrock
                    [4444, 944],   // Beorn's Hall
                    [4637, 945],   // Mirkwood
                    [4815, 962],   // Thranduil's Halls
                    [5105, 1125],  // Lake-town
                    [5161, 941],   // Erebor
                    [5105, 1125],  // Lake-town (return)
                    [4444, 944],   // Beorn's Hall (stays over winter)
                    [3922, 1096],  // Rivendell (stays with Elrond)
                    [3681, 1154],  // Last Bridge (return)
                    [2974, 1126],  // Brandywine Bridge (home)
                    [2746, 1115],  // Bag End (home)
                    [2974, 1126],  // Brandywine Bridge (retirement)
                    [3681, 1154],  // Last Bridge (to Rivendell)
                    [3922, 1096],  // Rivendell (retires here years later)
                    [3681, 1154],  // Last Bridge (Grey Havens)
                    [2974, 1126],  // Brandywine Bridge (Grey Havens)
                    [2266, 1150]   // Grey Havens (departs Middle-earth)
                ]
            },
            frodo: {
                label: "Frodo's Journey",
                color: '#c0392b',
                points: [
                    [2764, 1115],  // Bag End
                    [2988, 1178],  // Bucklebury Ferry
                    [3034, 1204],  // Crickhollow
                    [3098, 1178],  // Old Forest
                    [3185, 1144],  // Barrow-downs
                    [3254, 1139],  // Bree
                    [3484, 1097],  // Weathertop
                    [3681, 1154],  // Last Bridge
                    [3850, 1134],  // Ford of Bruinen
                    ...FELLOWSHIP_PATH,
                    [4740, 2032],  // Emyn Muil
                    [4894, 2150],  // Dead Marshes
                    [5033, 2660],  // Minas Morgul
                    [5106, 2544],  // Cirith Ungol
                    [5120, 2530],  // Tower of Cirith Ungol
                    [5419, 2532],  // Mount Doom
                    [4799, 2565],  // Field of Cormallen
                    [4720, 2641],  // Minas Tirith (coronation)
                    [3940, 1096],  // Rivendell (return journey)
                    [3681, 1154],  // Last Bridge (return)
                    [2974, 1126],  // Brandywine Bridge
                    [2848, 1147],  // Bywater (Scouring of the Shire)
                    [2764, 1115],  // Bag End (return to the Shire)
                    [2974, 1126],  // Brandywine Bridge (Grey Havens)
                    [2266, 1150]   // Grey Havens (departs Middle-earth)
                ]
            },
            aragorn: {
                label: "Aragorn's Journey",
                color: '#6a9f5b',
                points: [
                    [3254, 1139],  // Bree
                    [3484, 1097],  // Weathertop
                    [3681, 1154],  // Last Bridge
                    [3850, 1134],  // Ford of Bruinen
                    ...FELLOWSHIP_PATH,
                    [4029, 1818],  // Eaves of Fangorn
                    [4043, 1918],  // Fangorn
                    [3969, 2344],  // Edoras
                    [3760, 2277],  // Helm's Deep
                    [3775, 2039],  // Isengard
                    [3969, 2344],  // Edoras (return)
                    [4005, 2440],  // Dunharrow
                    [3886, 2470],  // Erech
                    [4509, 2977],  // Pelargir
                    [4784, 2638],  // Pelennor Fields
                    [4720, 2641],  // Minas Tirith
                    [5141, 2272],  // Black Gate
                    [4799, 2565],  // Field of Cormallen
                    [4720, 2641]   // Minas Tirith (coronation)
                ]
            },
            boromir: {
                label: "Boromir's Journey",
                color: '#8e6b3e',
                points: [
                    [4720, 2641],  // Minas Tirith
                    [4856, 2658],  // Osgiliath
                    [4600, 2400],  // Ithilien (northward)
                    [4300, 2100],  // Eastern Rohan
                    [3900, 1900],  // Gap region
                    [3600, 1700],  // Dunland
                    [3359, 1541],  // Tharbad (loses horse)
                    [3681, 1154],  // Last Bridge
                    [3850, 1134],  // Ford of Bruinen
                    ...FELLOWSHIP_PATH
                ]
            },
            merry_pippin: {
                label: "Merry & Pippin's Journey",
                color: '#d4813a',
                points: [
                    [2764, 1115],  // Bag End
                    [2988, 1178],  // Bucklebury Ferry
                    [3034, 1204],  // Crickhollow
                    [3098, 1178],  // Old Forest
                    [3185, 1144],  // Barrow-downs
                    [3254, 1139],  // Bree
                    [3484, 1097],  // Weathertop
                    [3681, 1154],  // Last Bridge
                    [3850, 1134],  // Ford of Bruinen
                    ...FELLOWSHIP_PATH,
                    [4029, 1818],  // Eaves of Fangorn (escape from Uruk-hai)
                    [4043, 1918],  // Fangorn
                    [3775, 2039]   // Isengard (Ents)
                ],
                branches: {
                    pippin: [
                        [3775, 2039],  // Isengard
                        [4720, 2641],  // Minas Tirith (with Gandalf)
                        [4784, 2638],  // Pelennor Fields
                        [5141, 2272],  // Black Gate
                        [4799, 2565],  // Field of Cormallen
                        [4720, 2641],  // Minas Tirith (coronation)
                        [3940, 1096],  // Rivendell
                        [2974, 1126],  // Brandywine Bridge
                        [2848, 1147],  // Bywater
                        [2764, 1115]   // Bag End
                    ],
                    merry: [
                        [3775, 2039],  // Isengard
                        [3969, 2344],  // Edoras (rides with Éowyn)
                        [4784, 2638],  // Pelennor Fields
                        [5141, 2272],  // Black Gate
                        [4799, 2565],  // Field of Cormallen
                        [4720, 2641],  // Minas Tirith (coronation)
                        [3940, 1096],  // Rivendell
                        [2974, 1126],  // Brandywine Bridge
                        [2848, 1147],  // Bywater
                        [2764, 1115]   // Bag End
                    ]
                }
            },
            gollum: {
                label: "Gollum's Journey",
                color: '#708090',
                points: [
                    [4417, 1370],  // River-folk (Sméagol's home)
                    [4417, 1370],  // Gladden Fields (finds Ring)
                    [4094, 1049],  // Misty Mountains (hides ~500 years)
                    [4417, 1370],  // Gladden Fields (leaves mountains)
                    [4463, 1801],  // Anduin valley (heading south)
                    [4740, 2032],  // Emyn Muil (passing through)
                    [4894, 2150],  // Dead Marshes (passing through)
                    [5141, 2272],  // Black Gate (enters Mordor, captured by Sauron)
                    [4894, 2150],  // Dead Marshes (released, heading west)
                    [4463, 1801],  // Anduin valley (tracking north)
                    [3981, 1515],  // Moria (picks up Fellowship's trail)
                    [4026, 1516],  // Dimrill Dale
                    [4300, 1609],  // East of Lothlórien (cannot enter)
                    [4463, 1801],  // Anduin (shadowing Fellowship)
                    [4569, 1985],  // Anduin
                    [4511, 2105],  // Argonath area
                    [4740, 2032],  // Emyn Muil (captured by Frodo)
                    [4894, 2150],  // Dead Marshes
                    [5141, 2272],  // Black Gate (turned away)
                    [5029, 2491],  // Henneth Annûn
                    [5033, 2660],  // Minas Morgul
                    [5106, 2544],  // Cirith Ungol (Shelob's Lair)
                    [5120, 2530],  // Tower of Cirith Ungol
                    [5419, 2532]   // Mount Doom (dies)
                ]
            },
            gandalf_hobbit: {
                label: "Gandalf's Journey (Hobbit)",
                color: '#00bcd4',
                points: [
                    [2746, 1115],  // Bag End
                    [3811, 937],   // Trollshaws
                    [3922, 1096],  // Rivendell
                    [4094, 1049],  // Misty Mountains
                    [4319, 976],   // Carrock
                    [4444, 944],   // Beorn's Hall
                    [4444, 944]    // Leaves company at Mirkwood edge
                ],
                branches: {
                    dol_guldur: [
                        [4444, 944],   // Leaves company
                        [4672, 1578],  // Dol Guldur (White Council)
                        [5161, 941]    // Erebor (returns for aftermath)
                    ]
                }
            },
            gandalf_lotr: {
                label: "Gandalf's Journey (LOTR)",
                color: '#00bcd4',
                points: [
                    [2764, 1115],  // Bag End (Bilbo's birthday)
                    [4720, 2641],  // Minas Tirith (researches the Ring)
                    [2764, 1115],  // Bag End (returns to warn Frodo)
                    [3775, 2039],  // Isengard (imprisoned by Saruman)
                    [3969, 2344],  // Edoras (escapes via eagle, takes Shadowfax)
                    [3484, 1097],  // Weathertop (arrives too late)
                    [3681, 1154],  // Last Bridge
                    [3940, 1096],  // Rivendell
                    [3930, 1190],  // South from Rivendell
                    [3915, 1280],  // Western foothills
                    [3900, 1370],  // Hollin (Eregion)
                    [3930, 1440],  // Approaching Caradhras
                    [3981, 1515],  // Moria (falls)
                    [4043, 1918],  // Fangorn (returns)
                    [3969, 2344],  // Edoras
                    [3760, 2277],  // Helm's Deep
                    [3775, 2039],  // Isengard
                    [4720, 2641],  // Minas Tirith
                    [4784, 2638],  // Pelennor Fields
                    [5141, 2272],  // Black Gate
                    [4799, 2565],  // Field of Cormallen
                    [4720, 2641]   // Minas Tirith (coronation)
                ]
            }
        };

        const journeyLayers = {};

        Object.keys(JOURNEYS).forEach(key => {
            const journey = JOURNEYS[key];
            const lines = [];
            const latlngs = journey.points.map(([px, py]) => toLatLng(px, py));
            lines.push(L.polyline(latlngs, {
                color: journey.color,
                weight: 3,
                dashArray: '10 6',
                opacity: 0.7,
                className: 'journey-path'
            }));
            if (journey.branches) {
                Object.values(journey.branches).forEach(branch => {
                    const branchLatLngs = branch.map(([px, py]) => toLatLng(px, py));
                    lines.push(L.polyline(branchLatLngs, {
                        color: journey.color,
                        weight: 3,
                        dashArray: '10 6',
                        opacity: 0.7,
                        className: 'journey-path'
                    }));
                });
            }
            journeyLayers[key] = L.layerGroup(lines);
        });

        // ── Legend ───────────────────────────────────────
        const legendEl = document.getElementById('legend-content');

        // ── Journey Toggles (top of legend) ───────────
        const journeyTitle = document.createElement('div');
        journeyTitle.className = 'legend-journeys-title';
        journeyTitle.textContent = 'Journeys';
        legendEl.appendChild(journeyTitle);

        Object.keys(JOURNEYS).forEach(key => {
            const journey = JOURNEYS[key];
            const toggle = document.createElement('div');
            toggle.className = 'journey-toggle disabled';
            toggle.innerHTML = `
                <div class="journey-line" style="border-color: ${journey.color};"></div>
                <span class="journey-label">${journey.label}</span>
            `;
            toggle.addEventListener('click', () => {
                toggle.classList.toggle('disabled');
                if (toggle.classList.contains('disabled')) {
                    map.removeLayer(journeyLayers[key]);
                } else {
                    map.addLayer(journeyLayers[key]);
                }
            });
            legendEl.appendChild(toggle);
        });

        const divider = document.createElement('hr');
        divider.className = 'legend-divider';
        legendEl.appendChild(divider);

        // ── Book Categories ────────────────────────────
        Object.keys(CATEGORY_LABELS).forEach(cat => {
            const catEvents = events.filter(e => e.category === cat);

            const div = document.createElement('div');
            div.className = 'legend-category';
            div.dataset.category = cat;

            div.innerHTML = `
                <div class="legend-category-header">
                    <div class="legend-dot" style="background: ${COLORS[cat]};"></div>
                    <span class="legend-category-label">${CATEGORY_LABELS[cat]}</span>
                    <span class="legend-toggle">&#9660;</span>
                </div>
                <div class="legend-items">
                    ${catEvents.map((e, i) => `<div class="legend-item" data-index="${events.indexOf(e)}">${e.name.split('—')[0].trim()}</div>`).join('')}
                </div>
            `;

            // Toggle category visibility
            div.querySelector('.legend-category-header').addEventListener('click', () => {
                div.classList.toggle('disabled');
                const toggle = div.querySelector('.legend-toggle');
                if (div.classList.contains('disabled')) {
                    map.removeLayer(categoryLayers[cat]);
                    toggle.innerHTML = '&#9654;';
                } else {
                    map.addLayer(categoryLayers[cat]);
                    toggle.innerHTML = '&#9660;';
                }
            });

            // Click legend item to fly to marker
            div.querySelectorAll('.legend-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const evt = events[parseInt(item.dataset.index)];
                    const latlng = toLatLng(evt.px, evt.py);
                    map.flyTo(latlng, 1, { duration: 0.8 });

                    // Open the popup
                    categoryLayers[evt.category].eachLayer(marker => {
                        if (marker._eventData === evt) {
                            setTimeout(() => marker.openPopup(), 400);
                        }
                    });
                });
            });

            legendEl.appendChild(div);
        });

        // ── Coordinate Toggle (bottom of legend) ──────
        const coordDivider = document.createElement('hr');
        coordDivider.className = 'legend-divider';
        legendEl.appendChild(coordDivider);

        let coordsEnabled = true;
        const coordToggleRow = document.createElement('div');
        coordToggleRow.className = 'coord-toggle-row active';
        coordToggleRow.innerHTML = `
            <div class="coord-toggle-switch"></div>
            <span class="coord-toggle-label">Show coordinates</span>
        `;
        coordToggleRow.addEventListener('click', () => {
            coordsEnabled = !coordsEnabled;
            coordToggleRow.classList.toggle('active', coordsEnabled);
            if (!coordsEnabled) {
                coordDisplay.style.display = 'none';
            }
        });
        legendEl.appendChild(coordToggleRow);

        // ── Legend Collapse (mobile) ────────────────────
        const legend = document.getElementById('legend');
        const collapseBtn = document.getElementById('collapse-btn');

        function checkMobile() {
            if (window.innerWidth < 600) {
                legend.style.display = 'none';
                collapseBtn.style.display = 'block';
            } else {
                legend.style.display = 'block';
                collapseBtn.style.display = 'none';
            }
        }

        collapseBtn.addEventListener('click', () => {
            if (legend.style.display === 'none') {
                legend.style.display = 'block';
                collapseBtn.style.display = 'none';
            }
        });

        // Close legend on map click (mobile)
        map.on('click', () => {
            if (window.innerWidth < 600) {
                legend.style.display = 'none';
                collapseBtn.style.display = 'block';
            }
        });

        window.addEventListener('resize', checkMobile);
        checkMobile();

        // ── Coordinate Picker (calibration tool) ────────
        const coordDisplay = document.createElement('div');
        coordDisplay.id = 'coord-display';
        coordDisplay.style.cssText = 'position:absolute;bottom:24px;left:16px;z-index:1000;background:rgba(44,36,24,0.95);border:2px solid #8b7355;border-radius:8px;padding:10px 14px;color:#d4c5a9;font-size:13px;font-family:monospace;pointer-events:none;display:none;';
        document.body.appendChild(coordDisplay);

        map.on('click', function(e) {
            if (!coordsEnabled) return;
            const px = Math.round(e.latlng.lng);
            const py = Math.round(e.latlng.lat);
            coordDisplay.style.display = 'block';
            coordDisplay.textContent = `px: ${px}, py: ${py}`;
            console.log(`{ px: ${px}, py: ${py} }`);
        });

        map.on('contextmenu', function(e) {
            if (!coordsEnabled) return;
            const px = Math.round(e.latlng.lng);
            const py = Math.round(e.latlng.lat);
            const text = `px: ${px}, py: ${py}`;
            navigator.clipboard.writeText(text);
            coordDisplay.style.display = 'block';
            coordDisplay.textContent = `${text}  (copied)`;
        });

        // ── Toast auto-hide ─────────────────────────────
        setTimeout(() => {
            document.getElementById('toast').classList.add('hidden');
        }, 5000);

        // ── Utility: darken a hex color ─────────────────
        function darken(hex, amount) {
            hex = hex.replace('#', '');
            const r = Math.max(0, parseInt(hex.substring(0, 2), 16) - amount);
            const g = Math.max(0, parseInt(hex.substring(2, 4), 16) - amount);
            const b = Math.max(0, parseInt(hex.substring(4, 6), 16) - amount);
            return `#${r.toString(16).padStart(2, '0')}${g.toString(16).padStart(2, '0')}${b.toString(16).padStart(2, '0')}`;
        }
    </script>
</body>
</html>
