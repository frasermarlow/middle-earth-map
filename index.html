<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Middle-earth — Interactive Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, Georgia, serif;
            background: #1a1a1a;
            overflow: hidden;
        }

        #map {
            width: 100vw;
            height: 100vh;
            background: #2c2418;
        }

        /* Legend Panel */
        #legend {
            position: absolute;
            top: 16px;
            right: 16px;
            z-index: 1000;
            background: rgba(44, 36, 24, 0.95);
            border: 2px solid #8b7355;
            border-radius: 8px;
            padding: 16px;
            color: #d4c5a9;
            max-width: 280px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            max-height: calc(100vh - 32px);
            overflow-y: auto;
        }

        #legend h2 {
            font-size: 16px;
            color: #e8d9b0;
            margin-bottom: 12px;
            text-align: center;
            border-bottom: 1px solid #8b7355;
            padding-bottom: 8px;
            letter-spacing: 1px;
        }

        .legend-category {
            margin-bottom: 10px;
        }

        .legend-category-header {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 6px 0;
            user-select: none;
        }

        .legend-category-header:hover {
            color: #f0e6cc;
        }

        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
            flex-shrink: 0;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .legend-category-label {
            font-size: 13px;
            font-weight: bold;
            flex-grow: 1;
        }

        .legend-toggle {
            font-size: 11px;
            opacity: 0.7;
            margin-left: 8px;
        }

        .legend-items {
            margin-left: 20px;
            font-size: 12px;
            color: #b8a88a;
        }

        .legend-item {
            padding: 3px 0;
            cursor: pointer;
            transition: color 0.2s;
        }

        .legend-item:hover {
            color: #f0e6cc;
        }

        .legend-category.disabled .legend-dot {
            opacity: 0.3;
        }

        .legend-category.disabled .legend-category-label {
            opacity: 0.4;
            text-decoration: line-through;
        }

        .legend-category.disabled .legend-items {
            display: none;
        }

        #collapse-btn {
            position: absolute;
            top: 16px;
            right: 16px;
            z-index: 1001;
            background: rgba(44, 36, 24, 0.95);
            border: 2px solid #8b7355;
            border-radius: 8px;
            color: #d4c5a9;
            padding: 8px 12px;
            cursor: pointer;
            font-family: inherit;
            font-size: 13px;
            display: none;
        }

        #collapse-btn:hover {
            background: rgba(60, 48, 30, 0.95);
        }

        /* Custom marker styles */
        .event-marker {
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.5), 0 0 10px rgba(0, 0, 0, 0.3);
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            font-size: 12px;
            line-height: 1;
        }

        .event-marker:hover {
            transform: scale(1.3);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.6), 0 0 20px rgba(255, 255, 255, 0.2);
        }

        /* Popup styling */
        .leaflet-popup-content-wrapper {
            background: rgba(44, 36, 24, 0.97);
            color: #d4c5a9;
            border: 2px solid #8b7355;
            border-radius: 8px;
            font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, Georgia, serif;
        }

        .leaflet-popup-tip {
            background: rgba(44, 36, 24, 0.97);
            border: 1px solid #8b7355;
        }

        .leaflet-popup-close-button {
            color: #d4c5a9 !important;
        }

        .popup-title {
            font-size: 15px;
            font-weight: bold;
            color: #e8d9b0;
            margin-bottom: 6px;
        }

        .popup-book {
            font-size: 11px;
            color: #a89070;
            margin-bottom: 6px;
            font-style: italic;
        }

        .popup-description {
            font-size: 13px;
            line-height: 1.5;
            color: #c8b898;
        }

        .popup-characters {
            font-size: 11px;
            color: #a89070;
            margin-top: 8px;
            border-top: 1px solid #6b5b45;
            padding-top: 6px;
        }

        /* Leaflet controls theming */
        .leaflet-control-zoom a {
            background: rgba(44, 36, 24, 0.95) !important;
            color: #d4c5a9 !important;
            border-color: #8b7355 !important;
        }

        .leaflet-control-zoom a:hover {
            background: rgba(60, 48, 30, 0.95) !important;
        }

        /* Scrollbar styling for legend */
        #legend::-webkit-scrollbar {
            width: 6px;
        }

        #legend::-webkit-scrollbar-track {
            background: transparent;
        }

        #legend::-webkit-scrollbar-thumb {
            background: #8b7355;
            border-radius: 3px;
        }

        /* Instructions toast */
        #toast {
            position: absolute;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            background: rgba(44, 36, 24, 0.92);
            border: 1px solid #8b7355;
            border-radius: 8px;
            padding: 10px 20px;
            color: #d4c5a9;
            font-size: 13px;
            opacity: 1;
            transition: opacity 1s ease;
            pointer-events: none;
            text-align: center;
        }

        #toast.hidden {
            opacity: 0;
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <div id="legend">
        <h2>Events of the War of the Ring</h2>
        <div id="legend-content"></div>
    </div>

    <button id="collapse-btn">Show Legend</button>

    <div id="toast">Scroll to zoom &middot; Drag to pan &middot; Click markers for details</div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // ── Map Dimensions ──────────────────────────────
        const IMG_W = 7680;
        const IMG_H = 4320;

        // ── Category Colors ─────────────────────────────
        const COLORS = {
            fellowship: '#c9a435',
            towers:     '#b85c38',
            king:       '#6a9f5b'
        };

        const CATEGORY_LABELS = {
            fellowship: 'The Fellowship of the Ring',
            towers:     'The Two Towers',
            king:       'The Return of the King'
        };

        const CATEGORY_ICONS = {
            fellowship: '\u2727',
            towers:     '\u2694',
            king:       '\u2655'
        };

        // ── Event Data ──────────────────────────────────
        // Pixel positions (origin top-left) converted to Leaflet [lat, lng]
        // lat = IMG_H - py, lng = px
        const events = [
            // ── The Fellowship of the Ring ──
            {
                name: "Bag End — Bilbo's Farewell",
                category: 'fellowship',
                px: 2050, py: 1200,
                description: "Bilbo Baggins celebrates his 111th birthday with a magnificent party, then vanishes using the One Ring. He leaves the Ring to his nephew Frodo, setting the quest in motion.",
                characters: "Bilbo, Frodo, Gandalf"
            },
            {
                name: "Bree — The Prancing Pony",
                category: 'fellowship',
                px: 2350, py: 1160,
                description: "Frodo and the hobbits meet the mysterious ranger Strider (Aragorn) at the Prancing Pony inn. Frodo accidentally puts on the Ring, drawing the attention of the Nazg\u00fbl.",
                characters: "Frodo, Sam, Merry, Pippin, Aragorn"
            },
            {
                name: "Weathertop — Attack of the Nazg\u00fbl",
                category: 'fellowship',
                px: 2600, py: 1120,
                description: "The Witch-king of Angmar stabs Frodo with a Morgul blade atop the ancient watchtower of Amon S\u00fbl. The wound nearly claims Frodo's life, leaving a lasting mark.",
                characters: "Frodo, Aragorn, the Nazg\u00fbl"
            },
            {
                name: "Rivendell — The Council of Elrond",
                category: 'fellowship',
                px: 2980, py: 1090,
                description: "Representatives of the Free Peoples gather at the Last Homely House. The Fellowship of the Ring is formed: nine companions to counter the nine Nazg\u00fbl, tasked with destroying the One Ring.",
                characters: "Frodo, Gandalf, Aragorn, Legolas, Gimli, Boromir, Sam, Merry, Pippin"
            },
            {
                name: "Moria — The Bridge of Khazad-d\u00fbm",
                category: 'fellowship',
                px: 2950, py: 1480,
                description: "The Fellowship passes through the abandoned Dwarven kingdom. After discovering the fate of Balin's colony, they are attacked by Orcs and a cave troll. Gandalf confronts the Balrog on the Bridge and falls into shadow.",
                characters: "Gandalf, the Balrog, the Fellowship"
            },
            {
                name: "Lothl\u00f3rien — The Golden Wood",
                category: 'fellowship',
                px: 3280, py: 1500,
                description: "The grieving Fellowship takes refuge in the Elven realm of Lady Galadriel. She shows Frodo the Mirror of Galadriel and resists the temptation of the Ring. The company receives Elven gifts and boats.",
                characters: "Galadriel, Celeborn, the Fellowship"
            },
            {
                name: "Amon Hen — The Breaking of the Fellowship",
                category: 'fellowship',
                px: 3420, py: 1620,
                description: "Boromir succumbs to the Ring's temptation and tries to take it from Frodo. Orcs attack; Boromir redeems himself defending Merry and Pippin but is slain. Frodo and Sam depart alone for Mordor.",
                characters: "Boromir, Frodo, Aragorn, Merry, Pippin, Lurtz"
            },

            // ── The Two Towers ──
            {
                name: "Fangorn Forest — The White Wizard",
                category: 'towers',
                px: 3050, py: 1700,
                description: "Merry and Pippin escape the Uruk-hai and meet Treebeard the Ent. Meanwhile, Aragorn, Legolas, and Gimli encounter Gandalf reborn as Gandalf the White.",
                characters: "Gandalf, Treebeard, Merry, Pippin, Aragorn, Legolas, Gimli"
            },
            {
                name: "Edoras — The Golden Hall of Meduseld",
                category: 'towers',
                px: 3120, py: 2080,
                description: "Gandalf frees King Th\u00e9oden from the influence of Saruman, channeled through Gr\u00edma Wormtongue. The people of Rohan prepare for war against Isengard's forces.",
                characters: "Gandalf, Th\u00e9oden, \u00c9owyn, \u00c9omer, Gr\u00edma"
            },
            {
                name: "Helm's Deep — The Battle of the Hornburg",
                category: 'towers',
                px: 2880, py: 2020,
                description: "The Rohirrim make a desperate stand against Saruman's army of 10,000 Uruk-hai at the fortress of Helm's Deep. Victory comes at dawn with the charge of Gandalf and the Rohirrim, and the arrival of the Huorns.",
                characters: "Th\u00e9oden, Aragorn, Legolas, Gimli, Gandalf, Haldir"
            },
            {
                name: "Isengard — The Ents' Assault",
                category: 'towers',
                px: 2810, py: 1820,
                description: "Roused to fury by Saruman's destruction of the forest, the Ents march on Isengard and break the dam, flooding the fortress and trapping Saruman in the tower of Orthanc.",
                characters: "Treebeard, Merry, Pippin, Saruman"
            },
            {
                name: "Emyn Muil — The Taming of Gollum",
                category: 'towers',
                px: 3650, py: 1680,
                description: "Frodo and Sam become lost in the rocky maze of Emyn Muil. They capture Gollum, who has been stalking them, and Frodo makes him swear on the Precious to serve as their guide to Mordor.",
                characters: "Frodo, Sam, Gollum"
            },
            {
                name: "The Dead Marshes",
                category: 'towers',
                px: 3880, py: 1750,
                description: "Gollum leads the hobbits through the treacherous Dead Marshes, where ghostly lights and the faces of the ancient dead lie beneath the water. A Nazg\u00fbl on a fell beast passes overhead.",
                characters: "Frodo, Sam, Gollum"
            },
            {
                name: "Osgiliath — Faramir's Choice",
                category: 'towers',
                px: 3980, py: 2130,
                description: "Faramir captures Frodo and Sam and brings them to Osgiliath. Unlike his brother Boromir, Faramir ultimately resists the Ring's pull and releases the hobbits to continue their quest.",
                characters: "Faramir, Frodo, Sam, Gollum"
            },

            // ── The Return of the King ──
            {
                name: "Minas Tirith — The Siege of Gondor",
                category: 'king',
                px: 3850, py: 2240,
                description: "Sauron's forces besiege the White City. The Witch-king breaks the Great Gate. Denethor, driven mad by the palant\u00edr, attempts to burn Faramir alive. The Rohirrim arrive at dawn to turn the tide.",
                characters: "Gandalf, Denethor, Faramir, Pippin"
            },
            {
                name: "Pelennor Fields — The Great Battle",
                category: 'king',
                px: 3960, py: 2310,
                description: "The greatest battle of the War of the Ring. Th\u00e9oden leads the Rohirrim charge. \u00c9owyn and Merry slay the Witch-king. Aragorn arrives with the Army of the Dead to rout Sauron's forces.",
                characters: "Th\u00e9oden, \u00c9owyn, Merry, Aragorn, the Witch-king"
            },
            {
                name: "Cirith Ungol — Shelob's Lair",
                category: 'king',
                px: 4200, py: 2050,
                description: "Gollum's treachery is revealed as he leads the hobbits into the lair of the giant spider Shelob. Frodo is stung and paralyzed. Sam drives Shelob away with the Phial of Galadriel and Sting, then rescues Frodo from the tower of Cirith Ungol.",
                characters: "Frodo, Sam, Gollum, Shelob"
            },
            {
                name: "The Black Gate — The Last Debate",
                category: 'king',
                px: 4260, py: 1780,
                description: "Aragorn leads the armies of the West to the Black Gate of Mordor in a desperate gambit to draw Sauron's Eye away from Frodo. Vastly outnumbered, they fight to buy time for the Ring-bearer.",
                characters: "Aragorn, Gandalf, Legolas, Gimli, Merry, Pippin"
            },
            {
                name: "Mount Doom — The End of All Things",
                category: 'king',
                px: 4500, py: 1980,
                description: "Frodo and Sam reach the Crack of Doom after an agonizing journey across Mordor. At the last moment, Frodo claims the Ring\u2014but Gollum bites it from his finger and falls into the fire, destroying the One Ring and Sauron forever.",
                characters: "Frodo, Sam, Gollum"
            }
        ];

        // ── Helper: pixel coords → Leaflet coords ──────
        function toLatLng(px, py) {
            return [IMG_H - py, px];
        }

        // ── Map Setup ───────────────────────────────────
        const map = L.map('map', {
            crs: L.CRS.Simple,
            minZoom: -2,
            maxZoom: 3,
            zoomSnap: 0.25,
            zoomDelta: 0.5,
            wheelPxPerZoomLevel: 120,
            attributionControl: false
        });

        const bounds = [[0, 0], [IMG_H, IMG_W]];
        L.imageOverlay('middle_earth.jpeg', bounds).addTo(map);
        map.fitBounds(bounds);
        map.setMaxBounds([[-200, -200], [IMG_H + 200, IMG_W + 200]]);

        // ── Create Markers ──────────────────────────────
        const categoryLayers = {
            fellowship: L.layerGroup(),
            towers: L.layerGroup(),
            king: L.layerGroup()
        };

        events.forEach(evt => {
            const latlng = toLatLng(evt.px, evt.py);
            const color = COLORS[evt.category];
            const icon = L.divIcon({
                className: '',
                html: `<div class="event-marker" style="
                    width: 22px; height: 22px;
                    background: radial-gradient(circle at 35% 35%, ${color}, ${darken(color, 40)});
                ">${CATEGORY_ICONS[evt.category]}</div>`,
                iconSize: [22, 22],
                iconAnchor: [11, 11],
                popupAnchor: [0, -14]
            });

            const marker = L.marker(latlng, { icon })
                .bindPopup(`
                    <div style="max-width: 260px;">
                        <div class="popup-title">${evt.name}</div>
                        <div class="popup-book">${CATEGORY_LABELS[evt.category]}</div>
                        <div class="popup-description">${evt.description}</div>
                        <div class="popup-characters"><strong>Key figures:</strong> ${evt.characters}</div>
                    </div>
                `, { maxWidth: 300 });

            marker._eventData = evt;
            categoryLayers[evt.category].addLayer(marker);
        });

        Object.values(categoryLayers).forEach(layer => layer.addTo(map));

        // ── Legend ───────────────────────────────────────
        const legendEl = document.getElementById('legend-content');

        Object.keys(CATEGORY_LABELS).forEach(cat => {
            const catEvents = events.filter(e => e.category === cat);

            const div = document.createElement('div');
            div.className = 'legend-category';
            div.dataset.category = cat;

            div.innerHTML = `
                <div class="legend-category-header">
                    <div class="legend-dot" style="background: ${COLORS[cat]};"></div>
                    <span class="legend-category-label">${CATEGORY_LABELS[cat]}</span>
                    <span class="legend-toggle">&#9660;</span>
                </div>
                <div class="legend-items">
                    ${catEvents.map((e, i) => `<div class="legend-item" data-index="${events.indexOf(e)}">${e.name.split('—')[0].trim()}</div>`).join('')}
                </div>
            `;

            // Toggle category visibility
            div.querySelector('.legend-category-header').addEventListener('click', () => {
                div.classList.toggle('disabled');
                const toggle = div.querySelector('.legend-toggle');
                if (div.classList.contains('disabled')) {
                    map.removeLayer(categoryLayers[cat]);
                    toggle.innerHTML = '&#9654;';
                } else {
                    map.addLayer(categoryLayers[cat]);
                    toggle.innerHTML = '&#9660;';
                }
            });

            // Click legend item to fly to marker
            div.querySelectorAll('.legend-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const evt = events[parseInt(item.dataset.index)];
                    const latlng = toLatLng(evt.px, evt.py);
                    map.flyTo(latlng, 1, { duration: 0.8 });

                    // Open the popup
                    categoryLayers[evt.category].eachLayer(marker => {
                        if (marker._eventData === evt) {
                            setTimeout(() => marker.openPopup(), 400);
                        }
                    });
                });
            });

            legendEl.appendChild(div);
        });

        // ── Legend Collapse (mobile) ────────────────────
        const legend = document.getElementById('legend');
        const collapseBtn = document.getElementById('collapse-btn');

        function checkMobile() {
            if (window.innerWidth < 600) {
                legend.style.display = 'none';
                collapseBtn.style.display = 'block';
            } else {
                legend.style.display = 'block';
                collapseBtn.style.display = 'none';
            }
        }

        collapseBtn.addEventListener('click', () => {
            if (legend.style.display === 'none') {
                legend.style.display = 'block';
                collapseBtn.style.display = 'none';
            }
        });

        // Close legend on map click (mobile)
        map.on('click', () => {
            if (window.innerWidth < 600) {
                legend.style.display = 'none';
                collapseBtn.style.display = 'block';
            }
        });

        window.addEventListener('resize', checkMobile);
        checkMobile();

        // ── Toast auto-hide ─────────────────────────────
        setTimeout(() => {
            document.getElementById('toast').classList.add('hidden');
        }, 5000);

        // ── Utility: darken a hex color ─────────────────
        function darken(hex, amount) {
            hex = hex.replace('#', '');
            const r = Math.max(0, parseInt(hex.substring(0, 2), 16) - amount);
            const g = Math.max(0, parseInt(hex.substring(2, 4), 16) - amount);
            const b = Math.max(0, parseInt(hex.substring(4, 6), 16) - amount);
            return `#${r.toString(16).padStart(2, '0')}${g.toString(16).padStart(2, '0')}${b.toString(16).padStart(2, '0')}`;
        }
    </script>
</body>
</html>
