<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Middle-earth — Interactive Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, Georgia, serif;
            background: #1a1a1a;
            overflow: hidden;
        }

        #map {
            width: 100vw;
            height: 100vh;
            background: #2c2418;
        }

        /* Legend Panel */
        #nav-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 44px;
            z-index: 1100;
            background: rgba(26, 26, 26, 0.92);
            border-bottom: 1px solid #5a4a36;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
        }
        .nav-link {
            color: #8b7355;
            text-decoration: none;
            font-size: 13px;
            padding: 6px 14px;
            border-radius: 4px;
            transition: color 0.2s, background 0.2s;
        }
        .nav-link:hover, .nav-link.active {
            color: #e8d9b0;
            background: rgba(139, 115, 85, 0.2);
        }
        .nav-title {
            font-size: 15px;
            color: #e8d9b0;
            letter-spacing: 2px;
        }
        @media (max-width: 500px) {
            .nav-title { display: none; }
        }
        #legend {
            position: absolute;
            top: 60px;
            right: 16px;
            z-index: 1000;
            background: rgba(44, 36, 24, 0.95);
            border: 2px solid #8b7355;
            border-radius: 8px;
            padding: 16px;
            color: #d4c5a9;
            max-width: 280px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            max-height: calc(100vh - 32px);
            overflow-y: auto;
        }

        #legend h2 {
            font-size: 16px;
            color: #e8d9b0;
            margin-bottom: 12px;
            text-align: center;
            border-bottom: 1px solid #8b7355;
            padding-bottom: 8px;
            padding-right: 32px;
            letter-spacing: 1px;
            position: relative;
        }

        #legend-close {
            position: absolute;
            top: -4px;
            right: 0;
            background: none;
            border: 1px solid #8b7355;
            border-radius: 4px;
            color: #a89070;
            font-size: 18px;
            cursor: pointer;
            width: 26px;
            height: 26px;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
            transition: color 0.2s, border-color 0.2s;
        }

        #legend-close:hover {
            color: #f0e6cc;
            border-color: #d4c5a9;
        }

        .legend-category {
            margin-bottom: 10px;
        }

        .legend-category-header {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 6px 0;
            user-select: none;
        }

        .legend-category-header:hover {
            color: #f0e6cc;
        }

        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
            flex-shrink: 0;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .legend-category-label {
            font-size: 13px;
            font-weight: bold;
            flex-grow: 1;
        }

        .legend-toggle {
            font-size: 11px;
            opacity: 0.7;
            margin-left: 8px;
        }

        .legend-items {
            margin-left: 20px;
            font-size: 12px;
            color: #b8a88a;
        }

        .legend-item {
            padding: 3px 0;
            cursor: pointer;
            transition: color 0.2s;
        }

        .legend-item:hover {
            color: #f0e6cc;
        }

        .legend-category.disabled .legend-dot {
            opacity: 0.3;
        }

        .legend-category.disabled .legend-category-label {
            opacity: 0.4;
            text-decoration: line-through;
        }

        .legend-category.disabled .legend-items {
            display: none;
        }

        #collapse-btn {
            position: absolute;
            top: 60px;
            right: 16px;
            z-index: 1001;
            background: rgba(44, 36, 24, 0.95);
            border: 2px solid #8b7355;
            border-radius: 8px;
            color: #d4c5a9;
            padding: 10px 14px;
            cursor: pointer;
            font-family: inherit;
            font-size: 14px;
            display: none;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            transition: background 0.2s, border-color 0.2s;
        }

        #collapse-btn:hover {
            background: rgba(60, 48, 30, 0.95);
            border-color: #d4c5a9;
        }

        .menu-icon {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        .menu-icon span {
            display: block;
            width: 16px;
            height: 2px;
            background: #d4c5a9;
            border-radius: 1px;
        }

        /* Custom marker styles */
        .event-marker {
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.5), 0 0 10px rgba(0, 0, 0, 0.3);
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            font-size: 12px;
            line-height: 1;
        }

        .event-marker:hover {
            transform: scale(1.3);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.6), 0 0 20px rgba(255, 255, 255, 0.2);
        }

        /* Popup styling */
        .leaflet-popup-content-wrapper {
            background: rgba(44, 36, 24, 0.97);
            color: #d4c5a9;
            border: 2px solid #8b7355;
            border-radius: 8px;
            font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, Georgia, serif;
        }

        .leaflet-popup-tip {
            background: rgba(44, 36, 24, 0.97);
            border: 1px solid #8b7355;
        }

        .leaflet-popup-close-button {
            color: #d4c5a9 !important;
        }

        .popup-title {
            font-size: 15px;
            font-weight: bold;
            color: #e8d9b0;
            margin-bottom: 6px;
        }

        .popup-book {
            font-size: 11px;
            color: #a89070;
            margin-bottom: 6px;
            font-style: italic;
        }

        .popup-description {
            font-size: 13px;
            line-height: 1.5;
            color: #c8b898;
        }

        .popup-characters {
            font-size: 11px;
            color: #a89070;
            margin-top: 8px;
            border-top: 1px solid #6b5b45;
            padding-top: 6px;
        }

        /* Leaflet controls theming */
        .leaflet-control-zoom a {
            background: rgba(44, 36, 24, 0.95) !important;
            color: #d4c5a9 !important;
            border-color: #8b7355 !important;
        }

        .leaflet-control-zoom a:hover {
            background: rgba(60, 48, 30, 0.95) !important;
        }

        /* Scrollbar styling for legend */
        #legend::-webkit-scrollbar {
            width: 6px;
        }

        #legend::-webkit-scrollbar-track {
            background: transparent;
        }

        #legend::-webkit-scrollbar-thumb {
            background: #8b7355;
            border-radius: 3px;
        }

        /* Journey paths — marching ants */
        @keyframes march {
            to { stroke-dashoffset: -20; }
        }

        .journey-path {
            animation: march 0.67s linear infinite;
        }

        /* Journey legend section */
        .legend-divider {
            border: none;
            border-top: 1px solid #8b7355;
            margin: 10px 0 8px;
        }

        .legend-journeys-title {
            font-size: 12px;
            color: #a89070;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 6px;
        }

        .journey-toggle {
            display: flex;
            align-items: center;
            padding: 5px 0;
            cursor: pointer;
            user-select: none;
            transition: color 0.2s;
        }

        .journey-toggle:hover {
            color: #f0e6cc;
        }

        .journey-toggle.disabled {
            opacity: 0.4;
        }

        .journey-line {
            width: 24px;
            height: 3px;
            margin-right: 8px;
            flex-shrink: 0;
            border-top: 3px dashed;
        }

        .journey-label {
            font-size: 12px;
        }

        .coord-toggle-row {
            display: flex;
            align-items: center;
            padding: 8px 0 4px;
            cursor: pointer;
            user-select: none;
        }

        .coord-toggle-switch {
            width: 32px;
            height: 18px;
            border-radius: 9px;
            background: #5a4a36;
            position: relative;
            margin-right: 8px;
            flex-shrink: 0;
            transition: background 0.2s;
        }

        .coord-toggle-switch::after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: #8b7355;
            transition: transform 0.2s, background 0.2s;
        }

        .coord-toggle-row.active .coord-toggle-switch {
            background: #6a9f5b;
        }

        .coord-toggle-row.active .coord-toggle-switch::after {
            transform: translateX(14px);
            background: #d4c5a9;
        }

        .coord-toggle-label {
            font-size: 12px;
            color: #a89070;
            transition: color 0.2s;
        }

        .coord-toggle-row.active .coord-toggle-label {
            color: #d4c5a9;
        }

        /* Instructions toast */
        #toast {
            position: absolute;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            background: rgba(44, 36, 24, 0.92);
            border: 1px solid #8b7355;
            border-radius: 8px;
            padding: 10px 20px;
            color: #d4c5a9;
            font-size: 13px;
            opacity: 1;
            transition: opacity 1s ease;
            pointer-events: none;
            text-align: center;
        }

        #toast.hidden {
            opacity: 0;
        }
    </style>
</head>
<body>
    <nav id="nav-bar">
        <a href="index.html" class="nav-link active">&#x1f5fa;&#xfe0e; Map</a>
        <span class="nav-title">Middle-earth</span>
        <a href="timeline.html" class="nav-link">&#x23f3;&#xfe0e; Timeline</a>
    </nav>
    <div id="map"></div>

    <div id="legend">
        <h2>Events of Middle-earth<button id="legend-close">&times;</button></h2>
        <div id="legend-content"></div>
    </div>

    <button id="collapse-btn"><div class="menu-icon"><span></span><span></span><span></span></div> Legend</button>

    <div id="toast">Scroll to zoom &middot; Drag to pan &middot; Click markers for details</div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="data.js"></script>
    <script>
        // Events, COLORS, CATEGORY_LABELS, CATEGORY_ICONS, FELLOWSHIP_PATH,
        // JOURNEYS, IMG_W, IMG_H loaded from data.js

        // ── Helper: pixel coords → Leaflet coords ──────
        function toLatLng(px, py) {
            return [py, px];
        }

        // ── Map Setup ───────────────────────────────────
        const MapCRS = L.Util.extend({}, L.CRS.Simple, {
            transformation: new L.Transformation(1, 0, 1, 0)
        });

        const map = L.map('map', {
            crs: MapCRS,
            minZoom: -4,
            maxZoom: 3,
            zoomSnap: 0.25,
            zoomDelta: 0.5,
            wheelPxPerZoomLevel: 120,
            attributionControl: false
        });

        const bounds = [[0, 0], [IMG_H, IMG_W]];
        L.tileLayer('tiles/{z}/{x}/{y}.jpg', {
            minZoom: -4,
            maxZoom: 3,
            maxNativeZoom: 0,
            minNativeZoom: -2,
            zoomOffset: 2,
            tileSize: 256,
            noWrap: true,
            bounds: bounds
        }).addTo(map);
        map.fitBounds(bounds);
        const PAD = Math.max(IMG_W, IMG_H);
        map.setMaxBounds([[-PAD, -PAD], [IMG_H + PAD, IMG_W + PAD]]);

        // ── Create Markers ──────────────────────────────
        const categoryLayers = {
            silmarillion: L.layerGroup(),
            hobbit: L.layerGroup(),
            fellowship: L.layerGroup(),
            towers: L.layerGroup(),
            king: L.layerGroup(),
            appendix: L.layerGroup()
        };

        events.forEach(evt => {
            const latlng = toLatLng(evt.px, evt.py);
            const color = COLORS[evt.category];
            const icon = L.divIcon({
                className: '',
                html: `<div class="event-marker" style="
                    width: 22px; height: 22px;
                    background: radial-gradient(circle at 35% 35%, ${color}, ${darken(color, 40)});
                ">${CATEGORY_ICONS[evt.category]}</div>`,
                iconSize: [22, 22],
                iconAnchor: [11, 11],
                popupAnchor: [0, -14]
            });

            const marker = L.marker(latlng, { icon })
                .bindPopup(`
                    <div style="max-width: 260px;">
                        <div class="popup-title">${evt.name}</div>
                        <div class="popup-book">${CATEGORY_LABELS[evt.category]}</div>
                        <div class="popup-description">${evt.description}</div>
                        <div class="popup-characters"><strong>Key figures:</strong> ${evt.characters}</div>
                    </div>
                `, { maxWidth: 300 });

            marker._eventData = evt;
            categoryLayers[evt.category].addLayer(marker);
        });

        Object.values(categoryLayers).forEach(layer => layer.addTo(map));

        // Catmull-Rom spline interpolation for smooth journey paths
        // Only interpolate segments longer than minDist to avoid loops on close points
        // Points with a truthy third element (e.g. [x, y, 1]) are always smoothed
        function smoothPoints(points, segments = 6, minDist = 100) {
            if (points.length < 3) return points;
            const result = [];
            for (let i = 0; i < points.length - 1; i++) {
                const p1 = points[i];
                const p2 = points[i + 1];
                const forceSmooth = p1[2] && p2[2];
                if (!forceSmooth) {
                    const dx = p2[0] - p1[0];
                    const dy = p2[1] - p1[1];
                    const dist = Math.sqrt(dx * dx + dy * dy);
                    if (dist < minDist) {
                        result.push(p1);
                        continue;
                    }
                }
                const p0 = points[Math.max(0, i - 1)];
                const p3 = points[Math.min(points.length - 1, i + 2)];
                for (let t = 0; t < segments; t++) {
                    const tt = t / segments;
                    const tt2 = tt * tt;
                    const tt3 = tt2 * tt;
                    result.push([
                        0.5 * ((2*p1[0]) + (-p0[0]+p2[0])*tt + (2*p0[0]-5*p1[0]+4*p2[0]-p3[0])*tt2 + (-p0[0]+3*p1[0]-3*p2[0]+p3[0])*tt3),
                        0.5 * ((2*p1[1]) + (-p0[1]+p2[1])*tt + (2*p0[1]-5*p1[1]+4*p2[1]-p3[1])*tt2 + (-p0[1]+3*p1[1]-3*p2[1]+p3[1])*tt3)
                    ]);
                }
            }
            result.push(points[points.length - 1]);
            return result;
        }

        const journeyLayers = {};

        Object.keys(JOURNEYS).forEach(key => {
            const journey = JOURNEYS[key];
            const lines = [];
            const smoothed = smoothPoints(journey.points);
            const latlngs = smoothed.map(([px, py]) => toLatLng(px, py));
            lines.push(L.polyline(latlngs, {
                color: journey.color,
                weight: 3,
                dashArray: '10 6',
                opacity: 0.7,
                className: 'journey-path'
            }));
            if (journey.branches) {
                Object.values(journey.branches).forEach(branch => {
                    const branchPoints = Array.isArray(branch) ? branch : branch.points;
                    const branchColor = Array.isArray(branch) ? journey.color : (branch.color || journey.color);
                    const smoothedBranch = smoothPoints(branchPoints);
                    const branchLatLngs = smoothedBranch.map(([px, py]) => toLatLng(px, py));
                    lines.push(L.polyline(branchLatLngs, {
                        color: branchColor,
                        weight: 3,
                        dashArray: '10 6',
                        opacity: 0.7,
                        className: 'journey-path'
                    }));
                });
            }
            journeyLayers[key] = L.layerGroup(lines);
        });

        // ── Legend ───────────────────────────────────────
        const legendEl = document.getElementById('legend-content');

        // ── Journey Toggles (top of legend) ───────────
        const journeyTitle = document.createElement('div');
        journeyTitle.className = 'legend-journeys-title';
        journeyTitle.textContent = 'Journeys';
        legendEl.appendChild(journeyTitle);

        Object.keys(JOURNEYS).forEach(key => {
            const journey = JOURNEYS[key];
            const toggle = document.createElement('div');
            toggle.className = 'journey-toggle disabled';
            toggle.innerHTML = `
                <div class="journey-line" style="border-color: ${journey.color};"></div>
                <span class="journey-label">${journey.label}</span>
            `;
            toggle.addEventListener('click', () => {
                toggle.classList.toggle('disabled');
                if (toggle.classList.contains('disabled')) {
                    map.removeLayer(journeyLayers[key]);
                } else {
                    map.addLayer(journeyLayers[key]);
                }
            });
            legendEl.appendChild(toggle);
        });

        const divider = document.createElement('hr');
        divider.className = 'legend-divider';
        legendEl.appendChild(divider);

        // ── Book Categories ────────────────────────────
        Object.keys(CATEGORY_LABELS).forEach(cat => {
            const catEvents = events.filter(e => e.category === cat);

            const div = document.createElement('div');
            div.className = 'legend-category';
            div.dataset.category = cat;

            div.innerHTML = `
                <div class="legend-category-header">
                    <div class="legend-dot" style="background: ${COLORS[cat]};"></div>
                    <span class="legend-category-label">${CATEGORY_LABELS[cat]}</span>
                    <span class="legend-toggle">&#9660;</span>
                </div>
                <div class="legend-items">
                    ${catEvents.map((e, i) => `<div class="legend-item" data-index="${events.indexOf(e)}">${e.name.split('—')[0].trim()}</div>`).join('')}
                </div>
            `;

            // Toggle category visibility
            div.querySelector('.legend-category-header').addEventListener('click', () => {
                div.classList.toggle('disabled');
                const toggle = div.querySelector('.legend-toggle');
                if (div.classList.contains('disabled')) {
                    map.removeLayer(categoryLayers[cat]);
                    toggle.innerHTML = '&#9654;';
                } else {
                    map.addLayer(categoryLayers[cat]);
                    toggle.innerHTML = '&#9660;';
                }
            });

            // Click legend item to fly to marker
            div.querySelectorAll('.legend-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const evt = events[parseInt(item.dataset.index)];
                    const latlng = toLatLng(evt.px, evt.py);
                    map.flyTo(latlng, 1, { duration: 0.8 });

                    // Open the popup
                    categoryLayers[evt.category].eachLayer(marker => {
                        if (marker._eventData === evt) {
                            setTimeout(() => marker.openPopup(), 400);
                        }
                    });
                });
            });

            legendEl.appendChild(div);
        });

        // ── Coordinate Toggle (bottom of legend) ──────
        const coordDivider = document.createElement('hr');
        coordDivider.className = 'legend-divider';
        legendEl.appendChild(coordDivider);

        let coordsEnabled = true;
        const coordToggleRow = document.createElement('div');
        coordToggleRow.className = 'coord-toggle-row active';
        coordToggleRow.innerHTML = `
            <div class="coord-toggle-switch"></div>
            <span class="coord-toggle-label">Show coordinates</span>
        `;
        coordToggleRow.addEventListener('click', () => {
            coordsEnabled = !coordsEnabled;
            coordToggleRow.classList.toggle('active', coordsEnabled);
            if (!coordsEnabled) {
                coordDisplay.style.display = 'none';
            }
        });
        legendEl.appendChild(coordToggleRow);

        // ── Legend Collapse ────────────────────
        const legend = document.getElementById('legend');
        const collapseBtn = document.getElementById('collapse-btn');
        const legendClose = document.getElementById('legend-close');

        function hideLegend() {
            legend.style.display = 'none';
            collapseBtn.style.display = 'flex';
        }

        function showLegend() {
            legend.style.display = 'block';
            collapseBtn.style.display = 'none';
        }

        legendClose.addEventListener('click', hideLegend);
        collapseBtn.addEventListener('click', showLegend);

        // Auto-collapse on mobile
        if (window.innerWidth < 600) {
            hideLegend();
        }

        // Close legend on map click (mobile)
        map.on('click', () => {
            if (window.innerWidth < 600) {
                hideLegend();
            }
        });

        // ── Coordinate Picker (calibration tool) ────────
        const coordDisplay = document.createElement('div');
        coordDisplay.id = 'coord-display';
        coordDisplay.style.cssText = 'position:absolute;bottom:24px;left:16px;z-index:1000;background:rgba(44,36,24,0.95);border:2px solid #8b7355;border-radius:8px;padding:10px 14px;color:#d4c5a9;font-size:13px;font-family:monospace;pointer-events:none;display:none;';
        document.body.appendChild(coordDisplay);

        map.on('click', function(e) {
            if (!coordsEnabled) return;
            const px = Math.round(e.latlng.lng);
            const py = Math.round(e.latlng.lat);
            coordDisplay.style.display = 'block';
            coordDisplay.textContent = `px: ${px}, py: ${py}`;
            console.log(`{ px: ${px}, py: ${py} }`);
        });

        map.on('contextmenu', function(e) {
            if (!coordsEnabled) return;
            const px = Math.round(e.latlng.lng);
            const py = Math.round(e.latlng.lat);
            const text = `px: ${px}, py: ${py}`;
            navigator.clipboard.writeText(text);
            coordDisplay.style.display = 'block';
            coordDisplay.textContent = `${text}  (copied)`;
        });

        // ── Toast auto-hide ─────────────────────────────
        setTimeout(() => {
            document.getElementById('toast').classList.add('hidden');
        }, 5000);

        // ── Utility: darken a hex color ─────────────────
        function darken(hex, amount) {
            hex = hex.replace('#', '');
            const r = Math.max(0, parseInt(hex.substring(0, 2), 16) - amount);
            const g = Math.max(0, parseInt(hex.substring(2, 4), 16) - amount);
            const b = Math.max(0, parseInt(hex.substring(4, 6), 16) - amount);
            return `#${r.toString(16).padStart(2, '0')}${g.toString(16).padStart(2, '0')}${b.toString(16).padStart(2, '0')}`;
        }

        // ── Cross-page navigation (from timeline) ─────
        (function() {
            const params = new URLSearchParams(window.location.search);
            const fly = params.get('fly');
            const eventName = params.get('event');
            if (fly) {
                const [px, py] = fly.split(',').map(Number);
                const latlng = toLatLng(px, py);
                setTimeout(() => {
                    map.flyTo(latlng, 1, { duration: 1.2 });
                    if (eventName) {
                        Object.values(categoryLayers).forEach(layer => {
                            layer.eachLayer(marker => {
                                if (marker.getPopup() && marker.getPopup().getContent().includes(eventName)) {
                                    setTimeout(() => marker.openPopup(), 1200);
                                }
                            });
                        });
                    }
                }, 500);
            }
        })();
    </script>
</body>
</html>
