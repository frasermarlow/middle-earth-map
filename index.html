<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Middle-earth — Interactive Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, Georgia, serif;
            background: #1a1a1a;
            overflow: hidden;
        }

        #map {
            width: 100vw;
            height: 100vh;
            background: #2c2418;
        }

        /* Legend Panel */
        #legend {
            position: absolute;
            top: 16px;
            right: 16px;
            z-index: 1000;
            background: rgba(44, 36, 24, 0.95);
            border: 2px solid #8b7355;
            border-radius: 8px;
            padding: 16px;
            color: #d4c5a9;
            max-width: 280px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            max-height: calc(100vh - 32px);
            overflow-y: auto;
        }

        #legend h2 {
            font-size: 16px;
            color: #e8d9b0;
            margin-bottom: 12px;
            text-align: center;
            border-bottom: 1px solid #8b7355;
            padding-bottom: 8px;
            letter-spacing: 1px;
        }

        .legend-category {
            margin-bottom: 10px;
        }

        .legend-category-header {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 6px 0;
            user-select: none;
        }

        .legend-category-header:hover {
            color: #f0e6cc;
        }

        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
            flex-shrink: 0;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .legend-category-label {
            font-size: 13px;
            font-weight: bold;
            flex-grow: 1;
        }

        .legend-toggle {
            font-size: 11px;
            opacity: 0.7;
            margin-left: 8px;
        }

        .legend-items {
            margin-left: 20px;
            font-size: 12px;
            color: #b8a88a;
        }

        .legend-item {
            padding: 3px 0;
            cursor: pointer;
            transition: color 0.2s;
        }

        .legend-item:hover {
            color: #f0e6cc;
        }

        .legend-category.disabled .legend-dot {
            opacity: 0.3;
        }

        .legend-category.disabled .legend-category-label {
            opacity: 0.4;
            text-decoration: line-through;
        }

        .legend-category.disabled .legend-items {
            display: none;
        }

        #collapse-btn {
            position: absolute;
            top: 16px;
            right: 16px;
            z-index: 1001;
            background: rgba(44, 36, 24, 0.95);
            border: 2px solid #8b7355;
            border-radius: 8px;
            color: #d4c5a9;
            padding: 8px 12px;
            cursor: pointer;
            font-family: inherit;
            font-size: 13px;
            display: none;
        }

        #collapse-btn:hover {
            background: rgba(60, 48, 30, 0.95);
        }

        /* Custom marker styles */
        .event-marker {
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.5), 0 0 10px rgba(0, 0, 0, 0.3);
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            font-size: 12px;
            line-height: 1;
        }

        .event-marker:hover {
            transform: scale(1.3);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.6), 0 0 20px rgba(255, 255, 255, 0.2);
        }

        /* Popup styling */
        .leaflet-popup-content-wrapper {
            background: rgba(44, 36, 24, 0.97);
            color: #d4c5a9;
            border: 2px solid #8b7355;
            border-radius: 8px;
            font-family: 'Palatino Linotype', 'Book Antiqua', Palatino, Georgia, serif;
        }

        .leaflet-popup-tip {
            background: rgba(44, 36, 24, 0.97);
            border: 1px solid #8b7355;
        }

        .leaflet-popup-close-button {
            color: #d4c5a9 !important;
        }

        .popup-title {
            font-size: 15px;
            font-weight: bold;
            color: #e8d9b0;
            margin-bottom: 6px;
        }

        .popup-book {
            font-size: 11px;
            color: #a89070;
            margin-bottom: 6px;
            font-style: italic;
        }

        .popup-description {
            font-size: 13px;
            line-height: 1.5;
            color: #c8b898;
        }

        .popup-characters {
            font-size: 11px;
            color: #a89070;
            margin-top: 8px;
            border-top: 1px solid #6b5b45;
            padding-top: 6px;
        }

        /* Leaflet controls theming */
        .leaflet-control-zoom a {
            background: rgba(44, 36, 24, 0.95) !important;
            color: #d4c5a9 !important;
            border-color: #8b7355 !important;
        }

        .leaflet-control-zoom a:hover {
            background: rgba(60, 48, 30, 0.95) !important;
        }

        /* Scrollbar styling for legend */
        #legend::-webkit-scrollbar {
            width: 6px;
        }

        #legend::-webkit-scrollbar-track {
            background: transparent;
        }

        #legend::-webkit-scrollbar-thumb {
            background: #8b7355;
            border-radius: 3px;
        }

        /* Instructions toast */
        #toast {
            position: absolute;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            background: rgba(44, 36, 24, 0.92);
            border: 1px solid #8b7355;
            border-radius: 8px;
            padding: 10px 20px;
            color: #d4c5a9;
            font-size: 13px;
            opacity: 1;
            transition: opacity 1s ease;
            pointer-events: none;
            text-align: center;
        }

        #toast.hidden {
            opacity: 0;
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <div id="legend">
        <h2>Events of Middle-earth</h2>
        <div id="legend-content"></div>
    </div>

    <button id="collapse-btn">Show Legend</button>

    <div id="toast">Scroll to zoom &middot; Drag to pan &middot; Click markers for details</div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // ── Map Dimensions ──────────────────────────────
        const IMG_W = 7680;
        const IMG_H = 4320;

        // ── Category Colors ─────────────────────────────
        const COLORS = {
            silmarillion: '#9b59b6',
            hobbit:       '#5b8fb9',
            fellowship:   '#c9a435',
            towers:       '#b85c38',
            king:         '#6a9f5b'
        };

        const CATEGORY_LABELS = {
            silmarillion: 'The Silmarillion',
            hobbit:       'The Hobbit',
            fellowship:   'The Fellowship of the Ring',
            towers:       'The Two Towers',
            king:         'The Return of the King'
        };

        const CATEGORY_ICONS = {
            silmarillion: '\u2756',
            hobbit:       '\u2302',
            fellowship:   '\u2727',
            towers:       '\u2694',
            king:         '\u2655'
        };

        // ── Event Data ──────────────────────────────────
        // Pixel positions (origin top-left) converted to Leaflet [lat, lng]
        // lat = IMG_H - py, lng = px
        const events = [
            // ── The Silmarillion ──
            {
                name: "The Grey Havens — Mithlond",
                category: 'silmarillion',
                px: 2266, py: 1150,
                description: "Founded by C\u00edrdan the Shipwright after the War of Wrath destroyed Beleriand, the Grey Havens became the chief port from which the Elves departed Middle-earth for the Undying Lands. It was from here that Gandalf, Frodo, Bilbo, Galadriel, and Elrond sailed at the end of the Third Age.",
                characters: "C\u00edrdan, Gil-galad, Galadriel"
            },
            {
                name: "Ered Luin — Nogrod & Belegost",
                category: 'silmarillion',
                px: 2192, py: 824,
                description: "The Blue Mountains housed the great Dwarven cities of Nogrod and Belegost in the First Age. The Dwarves of Nogrod crafted the Nauglam\u00edr and later sacked Doriath to reclaim it. After the ruin of Beleriand, many Dwarves migrated east to Khazad-d\u00fbm.",
                characters: "Durin's Folk, the Firebeards, the Broadbeams"
            },
            {
                name: "Eregion — The Rings of Power",
                category: 'silmarillion',
                px: 3885, py: 1520,
                description: "In the land of Holly near the West-gate of Moria, Celebrimbor and the Gwaith-i-M\u00edrdain were deceived by Sauron in his fair guise of Annatar, 'Lord of Gifts.' Together they forged the Rings of Power. When Sauron forged the One Ring, the Elves perceived his treachery. Sauron destroyed Eregion and slew Celebrimbor.",
                characters: "Celebrimbor, Sauron (as Annatar), Elrond"
            },
            {
                name: "Khazad-d\u00fbm — The Awakening of Durin",
                category: 'silmarillion',
                px: 4000, py: 1490,
                description: "Durin the Deathless, eldest of the seven Fathers of the Dwarves, awoke at Mount Gundabad and wandered south to the Mirrormere. There he founded Khazad-d\u00fbm, the greatest mansion of the Dwarves, which endured through all the ages until the Balrog was awakened in its depths.",
                characters: "Durin the Deathless"
            },
            {
                name: "Gladden Fields — The Disaster of the Gladden Fields",
                category: 'silmarillion',
                px: 4283, py: 1347,
                description: "Two years after the defeat of Sauron, Isildur and his company were ambushed by Orcs while marching north along the Anduin. Isildur put on the One Ring to escape, but it slipped from his finger in the river and he was slain by Orc arrows. The Ring was lost for nearly 2,500 years.",
                characters: "Isildur, Ohtar"
            },
            {
                name: "Dagorlad — The Last Alliance",
                category: 'silmarillion',
                px: 5100, py: 2220,
                description: "The Last Alliance of Elves and Men, led by Gil-galad and Elendil, fought the greatest battle of the Second Age on the plains before the Black Gate. After seven years besieging Barad-d\u00fbr, they overthrew Sauron, but both Gil-galad and Elendil fell. Isildur cut the One Ring from Sauron's hand.",
                characters: "Gil-galad, Elendil, Isildur, An\u00e1rion, Elrond, Sauron"
            },
            {
                name: "Barad-d\u00fbr — The Dark Tower",
                category: 'silmarillion',
                px: 5613, py: 2466,
                description: "Sauron began building his fortress in Mordor around SA 1000, using the power of the One Ring. The Dark Tower was besieged and thrown down by the Last Alliance, but because it was built with the Ring's power, it could not be fully destroyed while the Ring endured. Sauron rebuilt it when he returned to Mordor in the Third Age.",
                characters: "Sauron, the Nazg\u00fbl"
            },
            {
                name: "Mount Doom — The Forging of the One Ring",
                category: 'silmarillion',
                px: 5440, py: 2510,
                description: "In the fires of Orodruin, Sauron forged the One Ring to control all the other Rings of Power: 'One Ring to rule them all, One Ring to find them, One Ring to bring them all, and in the darkness bind them.' The moment he put it on, the Elven ring-bearers became aware of his purpose.",
                characters: "Sauron"
            },

            // ── The Hobbit ──
            {
                name: "Bag End — An Unexpected Party",
                category: 'hobbit',
                px: 2746, py: 1115,
                description: "Gandalf and thirteen Dwarves led by Thorin Oakenshield arrive uninvited at Bilbo Baggins' hobbit-hole, recruiting the bewildered hobbit as their burglar for a quest to reclaim the Lonely Mountain from the dragon Smaug.",
                characters: "Bilbo, Gandalf, Thorin, Balin, Dwalin, F\u00edli, K\u00edli, and company"
            },
            {
                name: "The Trollshaws — Three Trolls",
                category: 'hobbit',
                px: 3811, py: 937,
                description: "The company encounters three Stone-trolls\u2014Tom, Bert, and William\u2014who capture the Dwarves and plan to cook them. Gandalf tricks the trolls by mimicking their voices until dawn turns them to stone.",
                characters: "Bilbo, Gandalf, Thorin, the Trolls"
            },
            {
                name: "Rivendell — The Moon Letters",
                category: 'hobbit',
                px: 3922, py: 1096,
                description: "Elrond hosts the company and reads the moon letters on Thr\u00f3r's map, revealing the secret entrance to Erebor: 'Stand by the grey stone when the thrush knocks, and the last light of Durin's Day will shine upon the keyhole.'",
                characters: "Bilbo, Gandalf, Thorin, Elrond"
            },
            {
                name: "Misty Mountains — Riddles in the Dark",
                category: 'hobbit',
                px: 4094, py: 1049,
                description: "Captured by goblins in the High Pass, the company fights free, but Bilbo is separated and lost in the deep tunnels. There he discovers a golden ring and meets Gollum, defeating him in a game of riddles to find the way out.",
                characters: "Bilbo, Gollum, the Great Goblin"
            },
            {
                name: "The Carrock — Rescue by Eagles",
                category: 'hobbit',
                px: 4325, py: 944,
                description: "Pursued by Wargs and goblins, the company is trapped in trees and saved by the Great Eagles, who carry them to safety at the Carrock, a great rock in the river Anduin.",
                characters: "Bilbo, Gandalf, Thorin, the Great Eagles"
            },
            {
                name: "Beorn's Hall",
                category: 'hobbit',
                px: 4444, py: 944,
                description: "The company takes refuge with Beorn, a great skin-changer who can take the form of a bear. He confirms the goblins' pursuit and lends them ponies and provisions for the journey through Mirkwood.",
                characters: "Bilbo, Gandalf, Thorin, Beorn"
            },
            {
                name: "Mirkwood — Spiders and Shadows",
                category: 'hobbit',
                px: 4637, py: 945,
                description: "Without Gandalf, the company enters the dark forest of Mirkwood. They are ensnared by giant spiders. Bilbo uses the Ring and his Elven blade (which he names Sting) to free the Dwarves in his first true act of heroism.",
                characters: "Bilbo, Thorin, the Dwarves"
            },
            {
                name: "Thranduil's Halls — The Woodland Realm",
                category: 'hobbit',
                px: 4833, py: 960,
                description: "The Wood-elves of King Thranduil capture the Dwarves and imprison them. Bilbo, invisible with the Ring, sneaks through the halls for weeks before devising an escape plan using empty barrels floated down the Forest River.",
                characters: "Bilbo, Thorin, Thranduil"
            },
            {
                name: "Lake-town — Welcome to Esgaroth",
                category: 'hobbit',
                px: 5115, py: 1097,
                description: "The company arrives at the trade town of Esgaroth on the Long Lake. Thorin declares himself King under the Mountain, and the Men of the Lake welcome the Dwarves, hoping for the return of the old prosperity foretold in legend.",
                characters: "Bilbo, Thorin, Bard, the Master of Lake-town"
            },
            {
                name: "Erebor — Inside the Lonely Mountain",
                category: 'hobbit',
                px: 5161, py: 941,
                description: "Bilbo creeps down the secret passage and confronts Smaug the Golden in his vast treasure hoard. The hobbit's clever riddling conversation reveals the dragon's one weak spot\u2014a bare patch on his left breast.",
                characters: "Bilbo, Smaug, Thorin"
            },
            {
                name: "Dale — The Battle of Five Armies",
                category: 'hobbit',
                px: 5123, py: 983,
                description: "After Bard slays Smaug, five armies converge on the Lonely Mountain: Men, Elves, Dwarves, Goblins, and Wargs. The Free Peoples unite against the goblin horde. Thorin is mortally wounded but reconciles with Bilbo before dying.",
                characters: "Thorin, Bilbo, Bard, Thranduil, D\u00e1in, Beorn, the Great Eagles"
            },

            // ── The Fellowship of the Ring ──
            {
                name: "Bag End — Bilbo's Farewell",
                category: 'fellowship',
                px: 2764, py: 1115,
                description: "Bilbo Baggins celebrates his 111th birthday with a magnificent party, then vanishes using the One Ring. He leaves the Ring to his nephew Frodo, setting the quest in motion.",
                characters: "Bilbo, Frodo, Gandalf"
            },
            {
                name: "Bree — The Prancing Pony",
                category: 'fellowship',
                px: 3254, py: 1107,
                description: "Frodo and the hobbits meet the mysterious ranger Strider (Aragorn) at the Prancing Pony inn. Frodo accidentally puts on the Ring, drawing the attention of the Nazg\u00fbl.",
                characters: "Frodo, Sam, Merry, Pippin, Aragorn"
            },
            {
                name: "Weathertop — Attack of the Nazg\u00fbl",
                category: 'fellowship',
                px: 3488, py: 1077,
                description: "The Witch-king of Angmar stabs Frodo with a Morgul blade atop the ancient watchtower of Amon S\u00fbl. The wound nearly claims Frodo's life, leaving a lasting mark.",
                characters: "Frodo, Aragorn, the Nazg\u00fbl"
            },
            {
                name: "Rivendell — The Council of Elrond",
                category: 'fellowship',
                px: 3940, py: 1096,
                description: "Representatives of the Free Peoples gather at the Last Homely House. The Fellowship of the Ring is formed: nine companions to counter the nine Nazg\u00fbl, tasked with destroying the One Ring.",
                characters: "Frodo, Gandalf, Aragorn, Legolas, Gimli, Boromir, Sam, Merry, Pippin"
            },
            {
                name: "Moria — The Bridge of Khazad-d\u00fbm",
                category: 'fellowship',
                px: 3981, py: 1515,
                description: "The Fellowship passes through the abandoned Dwarven kingdom. After discovering the fate of Balin's colony, they are attacked by Orcs and a cave troll. Gandalf confronts the Balrog on the Bridge and falls into shadow.",
                characters: "Gandalf, the Balrog, the Fellowship"
            },
            {
                name: "Lothl\u00f3rien — The Golden Wood",
                category: 'fellowship',
                px: 4214, py: 1609,
                description: "The grieving Fellowship takes refuge in the Elven realm of Lady Galadriel. She shows Frodo the Mirror of Galadriel and resists the temptation of the Ring. The company receives Elven gifts and boats.",
                characters: "Galadriel, Celeborn, the Fellowship"
            },
            {
                name: "Amon Hen — The Breaking of the Fellowship",
                category: 'fellowship',
                px: 4494, py: 2152,
                description: "Boromir succumbs to the Ring's temptation and tries to take it from Frodo. Orcs attack; Boromir redeems himself defending Merry and Pippin but is slain. Frodo and Sam depart alone for Mordor.",
                characters: "Boromir, Frodo, Aragorn, Merry, Pippin, Lurtz"
            },

            // ── The Two Towers ──
            {
                name: "Fangorn Forest — The White Wizard",
                category: 'towers',
                px: 4043, py: 1918,
                description: "Merry and Pippin escape the Uruk-hai and meet Treebeard the Ent. Meanwhile, Aragorn, Legolas, and Gimli encounter Gandalf reborn as Gandalf the White.",
                characters: "Gandalf, Treebeard, Merry, Pippin, Aragorn, Legolas, Gimli"
            },
            {
                name: "Edoras — The Golden Hall of Meduseld",
                category: 'towers',
                px: 4020, py: 2348,
                description: "Gandalf frees King Th\u00e9oden from the influence of Saruman, channeled through Gr\u00edma Wormtongue. The people of Rohan prepare for war against Isengard's forces.",
                characters: "Gandalf, Th\u00e9oden, \u00c9owyn, \u00c9omer, Gr\u00edma"
            },
            {
                name: "Helm's Deep — The Battle of the Hornburg",
                category: 'towers',
                px: 3783, py: 2241,
                description: "The Rohirrim make a desperate stand against Saruman's army of 10,000 Uruk-hai at the fortress of Helm's Deep. Victory comes at dawn with the charge of Gandalf and the Rohirrim, and the arrival of the Huorns.",
                characters: "Th\u00e9oden, Aragorn, Legolas, Gimli, Gandalf, Haldir"
            },
            {
                name: "Isengard — The Ents' Assault",
                category: 'towers',
                px: 3748, py: 1999,
                description: "Roused to fury by Saruman's destruction of the forest, the Ents march on Isengard and break the dam, flooding the fortress and trapping Saruman in the tower of Orthanc.",
                characters: "Treebeard, Merry, Pippin, Saruman"
            },
            {
                name: "Emyn Muil — The Taming of Gollum",
                category: 'towers',
                px: 4740, py: 2032,
                description: "Frodo and Sam become lost in the rocky maze of Emyn Muil. They capture Gollum, who has been stalking them, and Frodo makes him swear on the Precious to serve as their guide to Mordor.",
                characters: "Frodo, Sam, Gollum"
            },
            {
                name: "The Dead Marshes",
                category: 'towers',
                px: 4894, py: 2150,
                description: "Gollum leads the hobbits through the treacherous Dead Marshes, where ghostly lights and the faces of the ancient dead lie beneath the water. A Nazg\u00fbl on a fell beast passes overhead.",
                characters: "Frodo, Sam, Gollum"
            },
            {
                name: "Osgiliath — Faramir's Choice",
                category: 'towers',
                px: 4856, py: 2658,
                description: "Faramir captures Frodo and Sam and brings them to Osgiliath. Unlike his brother Boromir, Faramir ultimately resists the Ring's pull and releases the hobbits to continue their quest.",
                characters: "Faramir, Frodo, Sam, Gollum"
            },

            // ── The Return of the King ──
            {
                name: "Minas Tirith — The Siege of Gondor",
                category: 'king',
                px: 4720, py: 2641,
                description: "Sauron's forces besiege the White City. The Witch-king breaks the Great Gate. Denethor, driven mad by the palant\u00edr, attempts to burn Faramir alive. The Rohirrim arrive at dawn to turn the tide.",
                characters: "Gandalf, Denethor, Faramir, Pippin"
            },
            {
                name: "Pelennor Fields — The Great Battle",
                category: 'king',
                px: 4784, py: 2638,
                description: "The greatest battle of the War of the Ring. Th\u00e9oden leads the Rohirrim charge. \u00c9owyn and Merry slay the Witch-king. Aragorn arrives with the Army of the Dead to rout Sauron's forces.",
                characters: "Th\u00e9oden, \u00c9owyn, Merry, Aragorn, the Witch-king"
            },
            {
                name: "Minas Morgul — The Dead City",
                category: 'king',
                px: 5033, py: 2660,
                description: "The hobbits pass the dread city of Minas Morgul, once Minas Ithil, now home to the Witch-king and his Nazg\u00fbl. As they climb the stairs beside it, the army of Morgul issues forth, led by the Witch-king, marching to war against Gondor.",
                characters: "Frodo, Sam, Gollum, the Witch-king"
            },
            {
                name: "Cirith Ungol — Shelob's Lair",
                category: 'king',
                px: 5106, py: 2544,
                description: "Gollum's treachery is revealed as he leads the hobbits into the lair of the giant spider Shelob. Frodo is stung and paralyzed. Sam drives Shelob away with the Phial of Galadriel and Sting, then rescues Frodo from the tower of Cirith Ungol.",
                characters: "Frodo, Sam, Gollum, Shelob"
            },
            {
                name: "The Black Gate — The Last Debate",
                category: 'king',
                px: 5141, py: 2272,
                description: "Aragorn leads the armies of the West to the Black Gate of Mordor in a desperate gambit to draw Sauron's Eye away from Frodo. Vastly outnumbered, they fight to buy time for the Ring-bearer.",
                characters: "Aragorn, Gandalf, Legolas, Gimli, Merry, Pippin"
            },
            {
                name: "Mount Doom — The End of All Things",
                category: 'king',
                px: 5419, py: 2532,
                description: "Frodo and Sam reach the Crack of Doom after an agonizing journey across Mordor. At the last moment, Frodo claims the Ring\u2014but Gollum bites it from his finger and falls into the fire, destroying the One Ring and Sauron forever.",
                characters: "Frodo, Sam, Gollum"
            }
        ];

        // ── Helper: pixel coords → Leaflet coords ──────
        function toLatLng(px, py) {
            return [IMG_H - py, px];
        }

        // ── Map Setup ───────────────────────────────────
        const map = L.map('map', {
            crs: L.CRS.Simple,
            minZoom: -2,
            maxZoom: 3,
            zoomSnap: 0.25,
            zoomDelta: 0.5,
            wheelPxPerZoomLevel: 120,
            attributionControl: false
        });

        const bounds = [[0, 0], [IMG_H, IMG_W]];
        L.imageOverlay('middle_earth.jpeg', bounds).addTo(map);
        map.fitBounds(bounds);
        map.setMaxBounds([[-200, -200], [IMG_H + 200, IMG_W + 200]]);

        // ── Create Markers ──────────────────────────────
        const categoryLayers = {
            silmarillion: L.layerGroup(),
            hobbit: L.layerGroup(),
            fellowship: L.layerGroup(),
            towers: L.layerGroup(),
            king: L.layerGroup()
        };

        events.forEach(evt => {
            const latlng = toLatLng(evt.px, evt.py);
            const color = COLORS[evt.category];
            const icon = L.divIcon({
                className: '',
                html: `<div class="event-marker" style="
                    width: 22px; height: 22px;
                    background: radial-gradient(circle at 35% 35%, ${color}, ${darken(color, 40)});
                ">${CATEGORY_ICONS[evt.category]}</div>`,
                iconSize: [22, 22],
                iconAnchor: [11, 11],
                popupAnchor: [0, -14]
            });

            const marker = L.marker(latlng, { icon })
                .bindPopup(`
                    <div style="max-width: 260px;">
                        <div class="popup-title">${evt.name}</div>
                        <div class="popup-book">${CATEGORY_LABELS[evt.category]}</div>
                        <div class="popup-description">${evt.description}</div>
                        <div class="popup-characters"><strong>Key figures:</strong> ${evt.characters}</div>
                    </div>
                `, { maxWidth: 300 });

            marker._eventData = evt;
            categoryLayers[evt.category].addLayer(marker);
        });

        Object.values(categoryLayers).forEach(layer => layer.addTo(map));

        // ── Legend ───────────────────────────────────────
        const legendEl = document.getElementById('legend-content');

        Object.keys(CATEGORY_LABELS).forEach(cat => {
            const catEvents = events.filter(e => e.category === cat);

            const div = document.createElement('div');
            div.className = 'legend-category';
            div.dataset.category = cat;

            div.innerHTML = `
                <div class="legend-category-header">
                    <div class="legend-dot" style="background: ${COLORS[cat]};"></div>
                    <span class="legend-category-label">${CATEGORY_LABELS[cat]}</span>
                    <span class="legend-toggle">&#9660;</span>
                </div>
                <div class="legend-items">
                    ${catEvents.map((e, i) => `<div class="legend-item" data-index="${events.indexOf(e)}">${e.name.split('—')[0].trim()}</div>`).join('')}
                </div>
            `;

            // Toggle category visibility
            div.querySelector('.legend-category-header').addEventListener('click', () => {
                div.classList.toggle('disabled');
                const toggle = div.querySelector('.legend-toggle');
                if (div.classList.contains('disabled')) {
                    map.removeLayer(categoryLayers[cat]);
                    toggle.innerHTML = '&#9654;';
                } else {
                    map.addLayer(categoryLayers[cat]);
                    toggle.innerHTML = '&#9660;';
                }
            });

            // Click legend item to fly to marker
            div.querySelectorAll('.legend-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const evt = events[parseInt(item.dataset.index)];
                    const latlng = toLatLng(evt.px, evt.py);
                    map.flyTo(latlng, 1, { duration: 0.8 });

                    // Open the popup
                    categoryLayers[evt.category].eachLayer(marker => {
                        if (marker._eventData === evt) {
                            setTimeout(() => marker.openPopup(), 400);
                        }
                    });
                });
            });

            legendEl.appendChild(div);
        });

        // ── Legend Collapse (mobile) ────────────────────
        const legend = document.getElementById('legend');
        const collapseBtn = document.getElementById('collapse-btn');

        function checkMobile() {
            if (window.innerWidth < 600) {
                legend.style.display = 'none';
                collapseBtn.style.display = 'block';
            } else {
                legend.style.display = 'block';
                collapseBtn.style.display = 'none';
            }
        }

        collapseBtn.addEventListener('click', () => {
            if (legend.style.display === 'none') {
                legend.style.display = 'block';
                collapseBtn.style.display = 'none';
            }
        });

        // Close legend on map click (mobile)
        map.on('click', () => {
            if (window.innerWidth < 600) {
                legend.style.display = 'none';
                collapseBtn.style.display = 'block';
            }
        });

        window.addEventListener('resize', checkMobile);
        checkMobile();

        // ── Coordinate Picker (calibration tool) ────────
        const coordDisplay = document.createElement('div');
        coordDisplay.id = 'coord-display';
        coordDisplay.style.cssText = 'position:absolute;bottom:24px;left:16px;z-index:1000;background:rgba(44,36,24,0.95);border:2px solid #8b7355;border-radius:8px;padding:10px 14px;color:#d4c5a9;font-size:13px;font-family:monospace;pointer-events:none;display:none;';
        document.body.appendChild(coordDisplay);

        map.on('click', function(e) {
            const px = Math.round(e.latlng.lng);
            const py = IMG_H - Math.round(e.latlng.lat);
            coordDisplay.style.display = 'block';
            coordDisplay.textContent = `px: ${px}, py: ${py}`;
            console.log(`{ px: ${px}, py: ${py} }`);
        });

        map.on('contextmenu', function(e) {
            const px = Math.round(e.latlng.lng);
            const py = IMG_H - Math.round(e.latlng.lat);
            const text = `px: ${px}, py: ${py}`;
            navigator.clipboard.writeText(text);
            coordDisplay.style.display = 'block';
            coordDisplay.textContent = `${text}  (copied)`;
        });

        // ── Toast auto-hide ─────────────────────────────
        setTimeout(() => {
            document.getElementById('toast').classList.add('hidden');
        }, 5000);

        // ── Utility: darken a hex color ─────────────────
        function darken(hex, amount) {
            hex = hex.replace('#', '');
            const r = Math.max(0, parseInt(hex.substring(0, 2), 16) - amount);
            const g = Math.max(0, parseInt(hex.substring(2, 4), 16) - amount);
            const b = Math.max(0, parseInt(hex.substring(4, 6), 16) - amount);
            return `#${r.toString(16).padStart(2, '0')}${g.toString(16).padStart(2, '0')}${b.toString(16).padStart(2, '0')}`;
        }
    </script>
</body>
</html>
